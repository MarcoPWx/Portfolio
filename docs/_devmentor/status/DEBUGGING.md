---
layout: product
title: DEBUGGING
product: DevMentor
source: status/DEBUGGING.md
---

{% raw %}
# DevMentor Debugging Log

## Session: 2025-08-15

- **Context**: Local dev with API Gateway as single surface, LADS via dashboard, Redis intended from cluster/compose.

### Issue 1: Redis errors spam (`ECONNREFUSED 127.0.0.1:6379`)
- **Symptoms**: Gateway/UI logs flooded with ioredis connection refused.
- **Root cause**: Redis not running locally while services defaulted to `localhost:6379` (dev mode). Cluster Redis exists, but local routing wasn‚Äôt configured.  
- **Fix**: Started dev Redis via compose: `redis-cache` on 6379 and `redis-learning` on 6380.
- **Verification**:
  - `docker ps | grep redis` shows both containers up.
  - Gateway logs no longer show Redis connection refused.
- **Follow-ups**:
  - Add `REDIS_URL`/`REDIS_LEARNING_URL` to `.env.local` for each service when targeting cluster.
  - Provide `kubectl port-forward svc/redis 6379:6379 -n devmentor` helper if using cluster.

### Issue 2: `/lads/manifest` returns 504 via Gateway
- **Symptoms**: Gateway 504 and proxy error ECONNREFUSED to `http://localhost:3001/api/architecture/manifest`.
- **Root cause**: Dashboard (devmentor-ui) not reachable on 3001 at the moment of the request.
- **Fix**: Ensure `npm run dev+watch` is running; restart if needed.
- **Verification**:
  - `ps aux | grep next dev -p 3001` shows process.
  - `curl http://localhost:3001/api/architecture/manifest` returns JSON when ready.
- **Follow-ups**:
  - Add readiness check in E2E setup to wait for 3001 before smoke tests.

### Quick Commands
```
# Start Redis (dev)
cd devmentor/deployment/environments/development && docker-compose up -d redis-cache redis-learning

# Start UI with watcher
cd devmentor/devmentor-ui && npm run -s dev+watch

# Start API Gateway
cd devmentor/services/api-gateway && PORT=8000 DASHBOARD_URL=http://localhost:3001 npm start

# Smoke tests
curl -s http://localhost:8000/lads/manifest | jq .
curl -s -X POST http://localhost:8000/lads/generate -H 'Content-Type: application/json' -d '{"repoPath":"/Users/betolbook/Documents/github/NatureQuest"}' | jq .
curl -s 'http://localhost:8000/lads/diagram?format=svg&page=Services' > /tmp/services.svg
curl -s http://localhost:8000/swagger/aggregate | jq .
```

### Notes
- LADS database view: generated by Repo Analyzer parsing SQL/migrations and rendered as pages like ‚ÄúData Flow & Storage‚Äù.
- If manifest/diagram endpoints fail, check UI readiness and watcher logs. 

## Session: 2025-08-15 (continued)

### Issue 3: Individual Flow E2E Tests Generated - 71 Files
- **Context**: Bulk testing 70+ flows in single test was wrong approach
- **Solution**: Generated individual E2E test files for each flow
- **Status**: ‚úÖ **COMPLETE** - 71 individual test files created
- **Location**: `devmentor-ui/tests/e2e/flows/` (71 files)
- **Coverage**: 8 tests per flow = 568 total individual E2E tests
- **Benefits**: Better isolation, clearer reporting, parallel execution, focused debugging

### Issue 4: Documentation Structure Fragmentation  
- **Symptoms**: 303 docs scattered across conflicting structures
- **Root cause**: CATALOG.md doesn't match actual directory structure
- **Current structure**: Clean numbered hierarchy (00- through 05-)
- **Status**: üîÑ **IN PROGRESS** - Fixing catalog and navigation
- **Action needed**: Update CATALOG.md to match reality

### Issue 5: Unit Tests Not Proper Unit Tests
- **Symptoms**: `watcher.test.js` and `pattern-detection.test.js` making network calls
- **Root cause**: Integration tests disguised as unit tests
- **Fix**: ‚úÖ **FIXED** - Converted to proper unit tests with mocking
- **Result**: Proper isolation, no network dependencies, faster execution

### Current Session Commands
```bash
# Generate individual flow E2E tests (COMPLETED)
node scripts/generate-individual-flow-tests.js

# Run individual flow tests
npm run test:e2e:flows

# Run specific flow test
npx playwright test tests/e2e/flows/lads-pipeline.test.js

# Run tests in parallel (4x faster)
npm run test:e2e:flows:parallel

# Check documentation structure
find ../docs -type d | sort
find ../docs -name "*.md" | wc -l  # Result: 303 files
```

- **Context**: Align tests and LADS endpoints; avoid local Redis when cluster Redis is intended.
- **Problem**: LADS manifest 504 via gateway; Redis ECONNREFUSED earlier; watcher not testable.
- **Cause**: UI not running at 3001 during proxy calls; services pointed to localhost Redis; watcher auto-start complicated unit tests.
- **Fixes**:
  - Added API Gateway public routes for `/lads/*` and `/tooltips/generate` (already present).
  - Made watcher testable via `WATCH_ARCH_TEST_MODE=1` and exported `runUpdates`.
  - Added unit tests for DiagramGenerator and watcher.
  - Ensured Redis remains the cluster default for runtime; local Redis only for dev fallback (do not override cluster).
- **Verification**:
  - Unit tests compile in repo-analyzer with `ts-jest` config and Jest types.
  - Watcher unit test exercises three endpoints.
- **Follow-ups**:
  - Add integration tests hitting `/api/lads/generate` and diagram GET.
  - E2E to drive UI flow once dev server is up. 

## Session: 2025-08-15 (tests)

- **Goal**: All E2E green; broaden unit coverage (analyzer, diagram generator, watcher, caching, patterns).
- **Work**:
  - Added analyzer unit tests: `repo-analyzer/tests/enhanced-analyzer.test.ts` covering output shape and optional patterns.
  - Added Redis caching round-trip test (skips if cache module missing): `repo-analyzer/tests/redis-caching.test.ts`.
  - Added gateway E2E for LADS complete flow: `devmentor-ui/tests/e2e/lads-complete-flow.test.js` (manifest‚Üígenerate‚Üídiagram with retries, config-driven).
  - Added UI manifest unit probe: `devmentor-ui/tests/unit/pattern-detection.test.js`.
- **Notes**:
  - E2E relies on UI at 3001 and Gateway at 8000; tests use config in `devmentor/config/DEVMENTOR_AI_CONFIG.json` if present.
  - Analyzer import resilient to src/dist paths.
- **Next**:
  - Add explicit unit tests for `diagram-generators` node/edge shapes and IDs.
  - Add caching tests for tooltip generation endpoint via Gateway. 

## Session: 2025-08-15 (diagram verification)
- **Action**: POST /api/repo/diagram (UI) succeeded; fetched `Complete` and `Data Flow & Storage` SVGs.
- **Files**: `/tmp/complete.svg`, `/tmp/data-storage.svg`.
- **E2E Mode**: MSW-only suite green; live UI-backend E2E deferred until services behind Gateway are enabled. 

## Session: 2025-08-15 (green runs)
- **Action**: Ran unit (repo-analyzer, UI), integration (gateway LADS/tooltips), and E2E (MSW-only).
- **Result**: All green; integration tests skip gracefully if gateway health is offline.
- **Follow-up**: Resolve API Gateway TS errors to enable full live E2E via services 3002‚Äì3005. 

### ai-gateway build errors (TypeScript)
- **Observed**: `TS7030` (not all code paths return), `ExperienceLevel` enum/string mismatches, private method access, ioredis option mismatch, implicit anys.
- **Resolved**: Installed missing deps: `@octokit/rest`, `ioredis`, `@types/swagger-jsdoc`.
- **Next fixes**:
  - Ensure functions at `src/index.ts:173` and `:371` return on all paths.
  - Normalize `ExperienceLevel` to allowed values (`junior|mid|senior|principal`); guard/convert inputs; remove `'expert'` indexing.
  - Replace unsupported `ioredis` options (e.g., `retryDelayOnFailover`) with `retryStrategy` and valid config.
  - Expose a public handler on `RealTimeLearningSystem` instead of calling private `handleMessage`.
  - Add null checks (`string | null`) and explicit types where flagged. 

## Session: 2025-08-15 (debugging playbook)
- **Action**: Added structured playbook at `devmentor/docs/03-operations/COMMANDS.md` (updated path).
- **Why**: Standardize how to start/check services, inspect Redis, view logs, run LADS flows, and trace with Jaeger.
- **Includes**: Scenario template, microservice rollout, Gateway relation checks, Redis keys/streams, logs (AI/API Gateway), Jaeger/Kiali port-forwards, LADS E2E, readiness, K8s cheats. 

## Session: 2025-08-15 (stabilization updates)

### Changes
- Removed duplicate UI folders; kept only `devmentor/devmentor-ui`.
- Consolidated docs under numbered structure; moved `CATALOG.md` ‚Üí `docs/00-overview/` and restored `DOC_ORGANIZATION_GUIDE.md`.
- Refactored `/api/status` to be config-driven (env + `devmentor/config` fallbacks).
- Implemented SSE endpoint `/api/events` (Redis Pub/Sub ‚Üí UI) and wired UI consumption in `DashboardLayout`.
- Added unit tests for `GET /api/flows` and `POST /api/lads/generate` (501 path).

### Login & Auth
- Login via UI proxy `/api/auth/login` sets HTTP-only session cookie; verify with browser Network or curl using cookie jar.
- Istio currently enforces mTLS (STRICT) but has no JWT `RequestAuthentication`; app/gateway validates session.
- To enforce at mesh: add `RequestAuthentication` with `jwksUri` and tighten `AuthorizationPolicy`, or mirror JWT to `Authorization` header.

### E2E & Tour (Pending Actions)
- Unify E2E base URL (Docker 3000, Next dev 3001) and avoid dynamic SVG assertions.
- Harden guided tour selectors and gating across Dashboard/Projects/Architecture.
- Surface unit coverage JSON in Admin ‚Üí Testing tab.

### Verification
- SSE: open `/api/events` responds with event-stream; dashboard topbar shows incoming events as activity.
- Unit tests: `npm run test:unit` include new API route tests.
- Docs: `find devmentor/docs -maxdepth 2 -type d` shows only canonical folders in root.

### Follow-ups
- Enrich architecture tooltips with deep links (endpoints, docs, config keys).
- Add Redis Streams for durable pipelines (analyzer ingest) and keep Pub/Sub for UI signals.
- Add `RequestAuthentication` in Istio if we choose mesh-level JWT enforcement. 

## Troubleshooting ‚Äì Scaling & Observability (2025-08-15)
- HPA suggestions show `{ note: 'No data' }`:
  - Ensure Prometheus reachable at `PROMETHEUS_URL` or `http://localhost:9090`
  - Verify metric names exist: `container_cpu_usage_seconds_total`, `kube_pod_container_resource_requests`
  - Query examples:
    - `sum(kube_deployment_status_replicas{namespace="devmentor-app",deployment="api-gateway"})`
    - `sum(rate(container_cpu_usage_seconds_total{namespace="devmentor-app",pod=~"api-gateway.*"}[5m]))`
- Logs not visible:
  - Compose: open Dozzle `http://localhost:8890`
  - K8s: install Loki+Promtail via Helm; in Lens use Logs view with Loki source; in Grafana use Explore ‚Üí LogQL
- Incident Center test:
  - Wrench ‚Üí Trigger Test Incident; verify triangle badge increments; dropdown lists newest first
- Diagram theme mismatch:
  - Ensure components import `getMermaidInit()` from `src/lib/mermaidTheme.ts`; rebuild if needed 

## Session Note ‚Äì 2025-08-15 (K8s context & observability)
- Selected cluster: `kind-devmentor` (kubectl current-context confirmed)
- Issue: Helm not installed locally ‚Üí cannot deploy Loki/Promtail and kube-prometheus-stack yet
- Immediate actions:
  1) `brew install helm`
  2) Deploy logs/metrics:
     - `helm repo add grafana https://grafana.github.io/helm-charts && helm repo add prometheus-community https://prometheus-community.github.io/helm-charts && helm repo update`
     - `helm upgrade --install loki grafana/loki-stack -n observability --create-namespace --set promtail.enabled=true --set grafana.enabled=false`
     - `helm upgrade --install kube-prometheus-stack prometheus-community/kube-prometheus-stack -n observability --create-namespace`
- Compose logs: Dozzle running at http://localhost:8890
- Next: add Alertmanager webhook ‚Üí `/api/incidents/alertmanager` to feed Incident Center; optional Jaeger tracing demo {% endraw %}
