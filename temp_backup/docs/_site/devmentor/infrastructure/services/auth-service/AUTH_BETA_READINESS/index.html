<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AUTH BETA READINESS | NatureQuest Documentation Hub</title>
  
  <!-- Google Fonts for better readability -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
  
  <style>
    :root {
      --primary-color: #0969da;
      --text-color: #24292f;
      --text-light: #57606a;
      --bg-light: #f6f8fa;
      --border-color: #d1d9e0;
    }
    
    * {
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
      font-size: 16px;
      line-height: 1.7;
      color: var(--text-color);
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      font-feature-settings: "kern" 1, "liga" 1;
    }
    
    /* Typography improvements */
    p {
      margin: 1.25rem 0;
      letter-spacing: -0.011em;
    }
    
    a {
      color: var(--primary-color);
      text-decoration: none;
      transition: all 0.2s ease;
    }
    
    a:hover {
      text-decoration: underline;
      opacity: 0.8;
    }
    
    /* Improved headings */
    h1, h2, h3, h4, h5, h6 {
      font-weight: 600;
      line-height: 1.3;
      margin-top: 2rem;
      margin-bottom: 1rem;
      letter-spacing: -0.02em;
    }
    
    h1 {
      font-size: 2.5rem;
      font-weight: 800;
      color: var(--primary-color);
      margin-top: 0;
      letter-spacing: -0.03em;
    }
    
    h2 {
      font-size: 1.875rem;
      font-weight: 700;
      color: var(--text-color);
      border-bottom: 1px solid var(--border-color);
      padding-bottom: 0.5rem;
    }
    
    h3 {
      font-size: 1.5rem;
      font-weight: 600;
      color: var(--text-color);
    }
    
    h4 {
      font-size: 1.25rem;
      font-weight: 600;
      color: var(--text-color);
    }
    
    /* Lists with better spacing */
    ul, ol {
      padding-left: 1.5rem;
      margin: 1.25rem 0;
    }
    
    li {
      margin: 0.5rem 0;
      line-height: 1.7;
    }
    
    /* Strong text */
    strong, b {
      font-weight: 600;
      color: var(--text-color);
    }
    
    /* Navigation */
    nav {
      background: linear-gradient(135deg, #f6f8fa 0%, #ffffff 100%);
      padding: 1.25rem;
      margin-bottom: 2rem;
      border-radius: 8px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.05);
    }
    
    nav ul {
      list-style: none;
      padding: 0;
      display: flex;
      gap: 1.5rem;
      flex-wrap: wrap;
      margin: 0;
    }
    
    nav li {
      margin: 0;
    }
    
    nav a {
      color: var(--text-color);
      text-decoration: none;
      font-weight: 500;
      font-size: 0.95rem;
      padding: 0.25rem 0.5rem;
      border-radius: 4px;
      transition: all 0.2s ease;
    }
    
    nav a:hover {
      background: var(--bg-light);
      color: var(--primary-color);
      text-decoration: none;
      opacity: 1;
    }
    
    /* Code blocks with JetBrains Mono */
    pre {
      background: var(--bg-light);
      padding: 1.25rem;
      border-radius: 8px;
      overflow-x: auto;
      border: 1px solid var(--border-color);
      margin: 1.5rem 0;
      font-size: 0.9rem;
    }
    
    code {
      font-family: 'JetBrains Mono', 'Consolas', 'Monaco', monospace;
      background: var(--bg-light);
      padding: 0.15rem 0.35rem;
      border-radius: 4px;
      font-size: 0.875em;
      font-weight: 500;
    }
    
    pre code {
      background: none;
      padding: 0;
      font-size: 0.875rem;
    }
    
    /* Tables */
    table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
      margin: 1.5rem 0;
      font-size: 0.95rem;
      border: 1px solid var(--border-color);
      border-radius: 8px;
      overflow: hidden;
    }
    
    th, td {
      padding: 0.75rem 1rem;
      text-align: left;
      border-bottom: 1px solid var(--border-color);
    }
    
    th {
      background: var(--bg-light);
      font-weight: 600;
      font-size: 0.875rem;
      text-transform: uppercase;
      letter-spacing: 0.025em;
      color: var(--text-light);
    }
    
    tr:last-child td {
      border-bottom: none;
    }
    
    tr:hover {
      background: rgba(246, 248, 250, 0.5);
    }
    
    /* Blockquotes */
    blockquote {
      margin: 1.5rem 0;
      padding: 1rem 1.25rem;
      border-left: 4px solid var(--primary-color);
      background: var(--bg-light);
      border-radius: 0 8px 8px 0;
      font-style: italic;
      color: var(--text-light);
    }
    
    /* Horizontal rules */
    hr {
      border: none;
      height: 1px;
      background: var(--border-color);
      margin: 2rem 0;
    }
    
    /* Main content area */
    main {
      min-height: 60vh;
    }
    
    /* Footer */
    footer {
      margin-top: 4rem;
      padding-top: 2rem;
      border-top: 1px solid var(--border-color);
      color: var(--text-light);
      font-size: 0.875rem;
    }
  </style>
</head>
<body>
  <nav>
    <ul>
      <li><a href="/">Home</a></li>
      <li><a href="/learning-roadmap/">Learning Roadmap</a></li>
      <li><a href="/all-docs/">All Docs</a></li>
      
      <li><a href="/">Home</a></li>
      
      <li><a href="/learning-roadmap/">Learning Roadmap</a></li>
      
      <li><a href="/devmentor/">DevMentor</a></li>
      
      <li><a href="/quizmentor/">QuizMentor</a></li>
      
      <li><a href="/harvest/">Harvest.ai</a></li>
      
      <li><a href="/naturequest-auth/">Auth</a></li>
      
      <li><a href="/infrastructure/">Infrastructure</a></li>
      
    </ul>
  </nav>

  <main>
    <div class="product-header" style="background: #f6f8fa; padding: 1rem; border-radius: 5px; margin-bottom: 2rem;">
  <span style="color: #666;">DevMentor</span> / 
  <span style="color: #999;">infrastructure/services/auth-service/AUTH_BETA_READINESS.md</span>
</div>

<h1>AUTH BETA READINESS</h1>


<p>CURRENT ARCHITECTURE</p>

<h1 id="-auth-service---beta-readiness">ğŸš€ Auth Service - BETA READINESS</h1>

<blockquote>
  <p><strong>Status</strong>: Pre-Beta<br />
<strong>Target Date</strong>: Beta Launch Ready in 5 Days<br />
<strong>Last Updated</strong>: August 16, 2025<br />
<strong>Priority</strong>: CRITICAL PATH<br />
<strong>Purpose</strong>: Complete auth service understanding, architecture, and beta readiness guide</p>
</blockquote>

<h2 id="-table-of-contents">ğŸ“š Table of Contents</h2>

<ol>
  <li><a href="#executive-summary">Executive Summary</a></li>
  <li><a href="#understanding-the-auth-service">Understanding the Auth Service</a></li>
  <li><a href="#key-benefits-of-centralization">Key Benefits of Centralization</a></li>
  <li><a href="#architecture-overview">Architecture Overview</a></li>
  <li><a href="#authentication-process-explained">Authentication Process Explained</a></li>
  <li><a href="#critical-security-tasks-days-1-2">Critical Security Tasks (Days 1-2)</a></li>
  <li><a href="#core-features-days-3-4">Core Features (Days 3-4)</a></li>
  <li><a href="#testing-deployment--monitoring">Testing, Deployment &amp; Monitoring</a></li>
  <li><a href="#troubleshooting--common-issues">Troubleshooting &amp; Common Issues</a></li>
</ol>

<hr />

<h2 id="executive-summary">Executive Summary</h2>

<p>The auth service is DevMentorâ€™s cornerstone for handling all user-related security features. It simplifies user authentication, authorization, and session management across all services.</p>

<h3 id="key-highlights">Key Highlights</h3>
<ul>
  <li><strong>Centralized Security</strong>: One-stop management for authentication and authorization.</li>
  <li><strong>Single Sign-On (SSO)</strong>: Seamless access across multiple services.</li>
  <li><strong>User Management</strong>: Consistent policies and controls from one place.</li>
  <li><strong>Enhanced Security Features</strong>: Robust protection against common attacks.</li>
</ul>

<p><strong>Beta Readiness Timeline</strong>:</p>
<ul>
  <li><strong>Time to Beta</strong>: 5 focused days</li>
  <li><strong>Critical Tasks</strong>: 8 to complete</li>
  <li><strong>Additional Features</strong>: 12 post-beta enhancements</li>
</ul>

<h3 id="why-this-matters">Why This Matters</h3>

<p>Without a secure auth service:</p>
<ul>
  <li>ğŸš« Each service implements its own (inconsistent) security</li>
  <li>ğŸš« Users need multiple logins</li>
  <li>ğŸš« Security vulnerabilities scattered across services</li>
  <li>ğŸš« No central user management</li>
  <li>ğŸš« Difficult to implement SSO or enterprise features</li>
</ul>

<p>With our centralized auth service:</p>
<ul>
  <li>âœ… Single sign-on (SSO) across all services</li>
  <li>âœ… Consistent security policies</li>
  <li>âœ… One place to fix security issues</li>
  <li>âœ… Easy user management</li>
  <li>âœ… Enterprise-ready (OAuth, SAML ready)</li>
</ul>

<hr />

<h2 id="understanding-the-auth-service">Understanding the Auth Service</h2>

<p>The Auth Service ensures secure user interactions and service access by centralizing key security operations:</p>

<ul>
  <li><strong>User Authentication</strong>: Verifying user identities during login.</li>
  <li><strong>Role-Based Authorization</strong>: Granting access based on user roles and permissions.</li>
  <li><strong>Session Management</strong>: Managing active user sessions with secure tokens.</li>
  <li><strong>Security Enforcement</strong>: Implementing protective measures like rate limiting and account lockout.</li>
  <li><strong>Activity Auditing</strong>: Logging of all auth-related transactions for transparency and compliance.</li>
</ul>

<h3 id="how-it-works">How It Works</h3>
<p>Think of the Auth Service as the <strong>digital security guard</strong> of your app, identification checks at the front, ensuring every user has the right access.</p>

<h3 id="key-components">Key Components</h3>
<p>Hereâ€™s how each component fits into the architecture:</p>

<table>
  <thead>
    <tr>
      <th>Component</th>
      <th>Purpose</th>
      <th>Port</th>
      <th>Technology</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><strong>Auth Service</strong></td>
      <td>Central auth logic</td>
      <td>3002</td>
      <td>Node.js/Express</td>
    </tr>
    <tr>
      <td><strong>API Gateway</strong></td>
      <td>Handles token validation and routing</td>
      <td>8000</td>
      <td>Express</td>
    </tr>
    <tr>
      <td><strong>PostgreSQL</strong></td>
      <td>Stores user data and session information</td>
      <td>5432</td>
      <td>PostgreSQL</td>
    </tr>
    <tr>
      <td><strong>Redis</strong></td>
      <td>Caches sessions, enforces rate limit</td>
      <td>6379</td>
      <td>Redis</td>
    </tr>
    <tr>
      <td><strong>SendGrid</strong></td>
      <td>Sends verification emails and password resets</td>
      <td>-</td>
      <td>Email API</td>
    </tr>
  </tbody>
</table>

<hr />

<h2 id="key-benefits-of-centralization">Key Benefits of Centralization</h2>

<p>Centralizing authentication with a dedicated auth service brings various advantages, including:</p>

<ul>
  <li><strong>Unified Security Management</strong>: Central control over authentication practices, implementation of security policies, and management of users.</li>
  <li><strong>Scalability</strong>: Ability to scale with user growth without compromising security.</li>
  <li><strong>Streamlined User Experience</strong>: Transparent sign-on (SSO) across all connected applications.</li>
  <li><strong>Reduced Complexity</strong>: Decreases the need for each application to implement security independently.</li>
</ul>

<hr />

<h2 id="architecture-overview">Architecture Overview</h2>

<h3 id="high-level-system-architecture">High-Level System Architecture</h3>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        AUTH SERVICE SYSTEM ARCHITECTURE                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

    [Web/Apps Users]               [Mobile Apps]
         â”‚                              â”‚
         â”œâ”€â”€â”€â”€â”€â”€â”€â–º Load Balancer â”€â”€â”€â”€â”€â”€â–º
         â”‚                              â”‚
         â–¼                              â–¼
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚  Web Client â”‚    â”‚ API Gateway  â”‚        â”‚ External APIs â”‚
  â”‚  Port: 3001 â”‚    â”‚ Port: 8000   â”‚        â”‚   (Future)    â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                   â”‚                        â”‚
         â”‚                   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                   â”‚
         â”‚       [Token Validation]
         â”‚                   â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                             â–¼                         â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”‚
                    â”‚ AUTH SERVICE â”‚                   â”‚
                    â”‚  Port: 3002  â”‚                   â”‚
                    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚
                           â”‚                           â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”                    â”‚
                    â–¼      â–¼      â–¼                    â–¼
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚PostgreSQLâ”‚ â”‚Redisâ”‚ â”‚SendGrid  â”‚  â”‚Business Svcs â”‚
            â”‚ Database â”‚ â”‚Cacheâ”‚ â”‚  Email   â”‚  â”‚â€¢ Memory:3003 â”‚
            â”‚          â”‚ â”‚     â”‚ â”‚          â”‚  â”‚â€¢ Project:3004â”‚
            â”‚ â€¢ Users  â”‚ â”‚     â”‚ â”‚          â”‚  â”‚â€¢ AI:3005     â”‚
            â”‚ â€¢ Sessionsâ”‚ â”‚     â”‚ â”‚          â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚ â€¢ Audit  â”‚ â”‚     â”‚ â”‚          â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre></div></div>

<h3 id="detailed-service-flow">Detailed Service Flow</h3>

<p>This detailed flow shows how requests move through the system:</p>

<ol>
  <li><strong>User Login</strong>
    <ul>
      <li>Users initiate login through the web client, prompting the flow through the auth service to verify credentials, generate tokens, and manage sessions.</li>
    </ul>
  </li>
  <li><strong>Authenticated API Request</strong>
    <ul>
      <li>After login, users access various business services through the API Gateway, where tokens are validated for secure access.</li>
    </ul>
  </li>
  <li><strong>Service-to-Service Tokens</strong>
    <ul>
      <li>Internal service communications are handled via mutual authentication, ensuring secure service-to-service interactions.</li>
    </ul>
  </li>
</ol>

<h3 id="database-schema">Database Schema</h3>

<p>A well-designed schema ensures efficient data management and security:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">â”Œâ”€â”€</span> <span class="k">DATABASE</span> <span class="k">STRUCTURE</span> <span class="err">â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span>
<span class="err">â”‚</span>                        <span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span>                                  <span class="err">â”‚</span>
<span class="err">â”‚</span>                        <span class="err">â”‚</span>    <span class="n">USERS</span>     <span class="err">â”‚</span>                                  <span class="err">â”‚</span>
<span class="err">â”‚</span>                        <span class="err">â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤</span>                                  <span class="err">â”‚</span>
<span class="err">â”‚</span>                        <span class="err">â”‚</span> <span class="n">id</span> <span class="p">(</span><span class="n">PK</span><span class="p">)</span>      <span class="err">â”‚</span>                                  <span class="err">â”‚</span>
<span class="err">â”‚</span>                        <span class="err">â”‚</span> <span class="n">email</span>        <span class="err">â”‚</span>                                  <span class="err">â”‚</span>
<span class="err">â”‚</span>                        <span class="err">â”‚</span> <span class="n">password_hash</span><span class="err">â”‚</span>                                  <span class="err">â”‚</span>
<span class="err">â”‚</span>                        <span class="err">â”‚</span> <span class="k">role</span>         <span class="err">â”‚</span>                                  <span class="err">â”‚</span>
<span class="err">â”‚</span>                        <span class="err">â”‚</span> <span class="n">created_at</span>   <span class="err">â”‚</span>                                  <span class="err">â”‚</span>
<span class="err">â”‚</span>                        <span class="err">â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”¬â”€â”€â”˜</span>                                  <span class="err">â”‚</span>
<span class="err">â”‚</span>                             <span class="mi">1</span><span class="err">â”‚</span>     <span class="err">â”‚</span><span class="mi">1</span>                                   <span class="err">â”‚</span>
<span class="err">â”‚</span>                              <span class="err">â–¼</span>     <span class="err">â–¼</span>                                    <span class="err">â”‚</span>
<span class="err">â”‚</span>               <span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span>   <span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span>                          <span class="err">â”‚</span>
<span class="err">â”‚</span>               <span class="err">â”‚</span> <span class="n">SESSIONS</span>   <span class="err">â”‚</span>   <span class="err">â”‚</span>    <span class="n">ROLES</span>    <span class="err">â”‚</span>                          <span class="err">â”‚</span>
<span class="err">â”‚</span>               <span class="err">â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤</span>   <span class="err">â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤</span>                          <span class="err">â”‚</span>
<span class="err">â”‚</span>               <span class="err">â”‚</span> <span class="n">user_id</span> <span class="p">(</span><span class="n">FK</span><span class="p">)</span><span class="err">â”‚</span>  <span class="err">â”‚</span> <span class="n">role_id</span> <span class="p">(</span><span class="n">PK</span><span class="p">)</span><span class="err">â”‚</span>                          <span class="err">â”‚</span>
<span class="err">â”‚</span>               <span class="err">â”‚</span> <span class="n">token</span>       <span class="err">â”‚</span>  <span class="err">â”‚</span> <span class="n">role_name</span>   <span class="err">â”‚</span>                          <span class="err">â”‚</span>
<span class="err">â”‚</span>               <span class="err">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span>  <span class="err">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span>                          <span class="err">â”‚</span>
<span class="err">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span>
</code></pre></div></div>

<hr />

<h2 id="how-authentication-works">How Authentication Works</h2>

<h3 id="1-registration-flow">1. Registration Flow</h3>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code> User          Frontend         Auth Service      Database       Email
  â”‚               â”‚                  â”‚               â”‚            â”‚
  â”œâ”€[Sign Up]â”€â”€â”€â”€â–ºâ”‚                  â”‚               â”‚            â”‚
  â”‚               â”œâ”€[Validate]       â”‚               â”‚            â”‚
  â”‚               â”œâ”€[POST /register]â–ºâ”‚               â”‚            â”‚
  â”‚               â”‚                  â”œâ”€[Check Email]â–ºâ”‚            â”‚
  â”‚               â”‚                  â”œâ”€[Hash Pass]   â”‚            â”‚
  â”‚               â”‚                  â”œâ”€[Create User]â–ºâ”‚            â”‚
  â”‚               â”‚                  â”œâ”€[Send Email]â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
  â”‚               â”‚â—„â”€[Success]â”€â”€â”€â”€â”€â”€â”€â”¤               â”‚            â”‚
  â”‚â—„â”€[Check Email]â”¤                  â”‚               â”‚            â”‚
  â”‚               â”‚                  â”‚               â”‚            â”‚
  â”‚â—„â•â•â•â•â•â•â•â•â•â•â•[Verification Email]â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â”¤
  â”‚               â”‚                  â”‚               â”‚            â”‚
  â”œâ”€[Click Link]â”€â–ºâ”‚                  â”‚               â”‚            â”‚
  â”‚               â”œâ”€[GET /verify]â”€â”€â”€â–ºâ”‚               â”‚            â”‚
  â”‚               â”‚                  â”œâ”€[Update User]â–ºâ”‚            â”‚
  â”‚               â”‚â—„â”€[Verified]â”€â”€â”€â”€â”€â”€â”¤               â”‚            â”‚
  â”‚â—„â”€[Welcome!]â”€â”€â”€â”¤                  â”‚               â”‚            â”‚
</code></pre></div></div>

<h3 id="2-login-flow-with-jwt">2. Login Flow with JWT</h3>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code> User          Frontend         Auth Service      Database
  â”‚               â”‚                  â”‚               â”‚
  â”œâ”€[Login]â”€â”€â”€â”€â”€â”€â–ºâ”‚                  â”‚               â”‚
  â”‚               â”œâ”€[POST /login]â”€â”€â”€â–ºâ”‚               â”‚
  â”‚               â”‚                  â”œâ”€[Find User]â”€â”€â–ºâ”‚
  â”‚               â”‚                  â”‚â—„â”€[User Data]â”€â”€â”¤
  â”‚               â”‚                  â”œâ”€[Verify Pass] â”‚
  â”‚               â”‚                  â”œâ”€[Check Lock]  â”‚
  â”‚               â”‚                  â”œâ”€[Generate JWT]â”‚
  â”‚               â”‚                  â”‚  â€¢ Access (15m)
  â”‚               â”‚                  â”‚  â€¢ Refresh (7d)
  â”‚               â”‚                  â”œâ”€[Store Session]â–º
  â”‚               â”‚â—„â”€[Tokens]â”€â”€â”€â”€â”€â”€â”€â”€â”¤               â”‚
  â”‚               â”œâ”€[Set Cookies]    â”‚               â”‚
  â”‚â—„â”€[Dashboard]â”€â”€â”¤                  â”‚               â”‚
</code></pre></div></div>

<h3 id="3-jwt-token-structure">3. JWT Token Structure</h3>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Access Token Payload</span>
<span class="p">{</span>
  <span class="dl">"</span><span class="s2">userId</span><span class="dl">"</span><span class="p">:</span> <span class="mi">123</span><span class="p">,</span>
  <span class="dl">"</span><span class="s2">email</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">user@example.com</span><span class="dl">"</span><span class="p">,</span>
  <span class="dl">"</span><span class="s2">role</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">user</span><span class="dl">"</span><span class="p">,</span>
  <span class="dl">"</span><span class="s2">type</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">access</span><span class="dl">"</span><span class="p">,</span>
  <span class="dl">"</span><span class="s2">iat</span><span class="dl">"</span><span class="p">:</span> <span class="mi">1692345600</span><span class="p">,</span>  <span class="c1">// Issued at</span>
  <span class="dl">"</span><span class="s2">exp</span><span class="dl">"</span><span class="p">:</span> <span class="mi">1692346500</span><span class="p">,</span>  <span class="c1">// Expires at (15 min)</span>
  <span class="dl">"</span><span class="s2">iss</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">devmentor.app</span><span class="dl">"</span><span class="p">,</span>
  <span class="dl">"</span><span class="s2">aud</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">devmentor-api</span><span class="dl">"</span>
<span class="p">}</span>

<span class="c1">// Refresh Token Payload</span>
<span class="p">{</span>
  <span class="dl">"</span><span class="s2">userId</span><span class="dl">"</span><span class="p">:</span> <span class="mi">123</span><span class="p">,</span>
  <span class="dl">"</span><span class="s2">type</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">refresh</span><span class="dl">"</span><span class="p">,</span>
  <span class="dl">"</span><span class="s2">iat</span><span class="dl">"</span><span class="p">:</span> <span class="mi">1692345600</span><span class="p">,</span>
  <span class="dl">"</span><span class="s2">exp</span><span class="dl">"</span><span class="p">:</span> <span class="mi">1692950400</span><span class="p">,</span>  <span class="c1">// Expires at (7 days)</span>
  <span class="dl">"</span><span class="s2">iss</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">devmentor.app</span><span class="dl">"</span>
<span class="p">}</span>
</code></pre></div></div>

<h3 id="4-token-validation-flow">4. Token Validation Flow</h3>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code> API Request â†’ API Gateway â†’ Business Service
      â”‚            â”‚              â”‚
      â”‚            â”œâ”€[Extract Token from Cookie/Header]
      â”‚            â”œâ”€[Verify JWT Signature]
      â”‚            â”œâ”€[Check Expiry]
      â”‚            â”œâ”€[Validate Issuer/Audience]
      â”‚            â”œâ”€[Add User Context Headers]
      â”‚            â”‚  â€¢ X-User-ID: 123
      â”‚            â”‚  â€¢ X-User-Role: admin
      â”‚            â”‚  â€¢ X-User-Email: user@...
      â”‚            â””â”€[Forward Request]â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
      â”‚                                        â”œâ”€[Process]
      â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€[Response]â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
</code></pre></div></div>

<hr />

<h2 id="-must-have---critical-security-days-1-2">ğŸ”´ MUST HAVE - Critical Security (Days 1-2)</h2>

<h3 id="1-generate--configure-secure-jwt-secrets-ï¸">1. Generate &amp; Configure Secure JWT Secrets âš ï¸</h3>

<p><strong>Status</strong>: âŒ Not Started<br />
<strong>Time</strong>: 2 hours<br />
<strong>Blocker</strong>: YES</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Step 1: Generate production secrets</span>
<span class="nb">cd</span> /Users/betolbook/Documents/github/NatureQuest/devmentor
<span class="nb">mkdir</span> <span class="nt">-p</span> secrets
openssl rand <span class="nt">-base64</span> 64 <span class="o">&gt;</span> secrets/jwt-secret.txt
openssl genrsa <span class="nt">-out</span> secrets/private.pem 2048
openssl rsa <span class="nt">-in</span> secrets/private.pem <span class="nt">-pubout</span> <span class="nt">-out</span> secrets/public.pem

<span class="c"># Step 2: Update .env files</span>
<span class="nb">echo</span> <span class="s2">"# Production Auth Secrets"</span> <span class="o">&gt;&gt;</span> .env.production
<span class="nb">echo</span> <span class="s2">"JWT_SECRET=</span><span class="si">$(</span><span class="nb">cat </span>secrets/jwt-secret.txt<span class="si">)</span><span class="s2">"</span> <span class="o">&gt;&gt;</span> .env.production
<span class="nb">echo</span> <span class="s2">"JWT_ALGORITHM=RS256"</span> <span class="o">&gt;&gt;</span> .env.production
<span class="nb">echo</span> <span class="s2">"ACCESS_TOKEN_EXPIRES=15m"</span> <span class="o">&gt;&gt;</span> .env.production
<span class="nb">echo</span> <span class="s2">"REFRESH_TOKEN_EXPIRES=7d"</span> <span class="o">&gt;&gt;</span> .env.production

<span class="c"># Step 3: Update auth-service configuration</span>
<span class="nb">cd </span>services/auth-service
<span class="nb">cp </span>src/config.ts src/config.ts.backup
</code></pre></div></div>

<p><strong>Code Update Required</strong> - <code class="language-plaintext highlighter-rouge">services/auth-service/src/config.ts</code>:</p>
<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">export</span> <span class="kd">const</span> <span class="nx">config</span> <span class="o">=</span> <span class="p">{</span>
  <span class="na">jwt</span><span class="p">:</span> <span class="p">{</span>
    <span class="na">secret</span><span class="p">:</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">JWT_SECRET</span> <span class="o">||</span> <span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="dl">'</span><span class="s1">JWT_SECRET is required in production</span><span class="dl">'</span><span class="p">);</span>
    <span class="p">})(),</span>
    <span class="na">algorithm</span><span class="p">:</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">JWT_ALGORITHM</span> <span class="o">||</span> <span class="dl">'</span><span class="s1">RS256</span><span class="dl">'</span><span class="p">,</span>
    <span class="na">accessTokenExpiry</span><span class="p">:</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">ACCESS_TOKEN_EXPIRES</span> <span class="o">||</span> <span class="dl">'</span><span class="s1">15m</span><span class="dl">'</span><span class="p">,</span>
    <span class="na">refreshTokenExpiry</span><span class="p">:</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">REFRESH_TOKEN_EXPIRES</span> <span class="o">||</span> <span class="dl">'</span><span class="s1">7d</span><span class="dl">'</span><span class="p">,</span>
    <span class="na">issuer</span><span class="p">:</span> <span class="dl">'</span><span class="s1">devmentor.app</span><span class="dl">'</span><span class="p">,</span>
    <span class="na">audience</span><span class="p">:</span> <span class="dl">'</span><span class="s1">devmentor-api</span><span class="dl">'</span>
  <span class="p">},</span>
  <span class="na">security</span><span class="p">:</span> <span class="p">{</span>
    <span class="na">bcryptRounds</span><span class="p">:</span> <span class="mi">12</span><span class="p">,</span>
    <span class="na">maxLoginAttempts</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span>
    <span class="na">lockoutDuration</span><span class="p">:</span> <span class="mi">30</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">,</span> <span class="c1">// 30 minutes</span>
    <span class="na">passwordMinLength</span><span class="p">:</span> <span class="mi">12</span><span class="p">,</span>
    <span class="na">requireStrongPassword</span><span class="p">:</span> <span class="kc">true</span>
  <span class="p">}</span>
<span class="p">};</span>
</code></pre></div></div>

<h3 id="2-implement-account-lockout-ï¸">2. Implement Account Lockout âš ï¸</h3>

<p><strong>Status</strong>: âŒ Not Started<br />
<strong>Time</strong>: 3 hours<br />
<strong>Blocker</strong>: YES</p>

<p><strong>Add to</strong> <code class="language-plaintext highlighter-rouge">services/auth-service/src/index.ts</code> (after line 164):</p>
<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Account lockout tracking</span>
<span class="kd">const</span> <span class="nx">loginAttempts</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Map</span><span class="o">&lt;</span><span class="kr">string</span><span class="p">,</span> <span class="p">{</span> <span class="na">count</span><span class="p">:</span> <span class="kr">number</span><span class="p">;</span> <span class="nl">lockedUntil</span><span class="p">?:</span> <span class="nb">Date</span> <span class="p">}</span><span class="o">&gt;</span><span class="p">();</span>

<span class="k">async</span> <span class="kd">function</span> <span class="nx">checkAccountLockout</span><span class="p">(</span><span class="nx">email</span><span class="p">:</span> <span class="kr">string</span><span class="p">):</span> <span class="nb">Promise</span><span class="o">&lt;</span><span class="nx">boolean</span><span class="o">&gt;</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">attempts</span> <span class="o">=</span> <span class="nx">loginAttempts</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="nx">email</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">attempts</span><span class="p">)</span> <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
  
  <span class="k">if</span> <span class="p">(</span><span class="nx">attempts</span><span class="p">.</span><span class="nx">lockedUntil</span> <span class="o">&amp;&amp;</span> <span class="nx">attempts</span><span class="p">.</span><span class="nx">lockedUntil</span> <span class="o">&gt;</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">())</span> <span class="p">{</span>
    <span class="k">return</span> <span class="kc">true</span><span class="p">;</span> <span class="c1">// Still locked out</span>
  <span class="p">}</span>
  
  <span class="k">if</span> <span class="p">(</span><span class="nx">attempts</span><span class="p">.</span><span class="nx">lockedUntil</span> <span class="o">&amp;&amp;</span> <span class="nx">attempts</span><span class="p">.</span><span class="nx">lockedUntil</span> <span class="o">&lt;=</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">())</span> <span class="p">{</span>
    <span class="nx">loginAttempts</span><span class="p">.</span><span class="k">delete</span><span class="p">(</span><span class="nx">email</span><span class="p">);</span> <span class="c1">// Clear expired lockout</span>
    <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
  <span class="p">}</span>
  
  <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">async</span> <span class="kd">function</span> <span class="nx">recordFailedLogin</span><span class="p">(</span><span class="nx">email</span><span class="p">:</span> <span class="kr">string</span><span class="p">):</span> <span class="nb">Promise</span><span class="o">&lt;</span><span class="k">void</span><span class="o">&gt;</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">attempts</span> <span class="o">=</span> <span class="nx">loginAttempts</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="nx">email</span><span class="p">)</span> <span class="o">||</span> <span class="p">{</span> <span class="na">count</span><span class="p">:</span> <span class="mi">0</span> <span class="p">};</span>
  <span class="nx">attempts</span><span class="p">.</span><span class="nx">count</span><span class="o">++</span><span class="p">;</span>
  
  <span class="k">if</span> <span class="p">(</span><span class="nx">attempts</span><span class="p">.</span><span class="nx">count</span> <span class="o">&gt;=</span> <span class="mi">5</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">attempts</span><span class="p">.</span><span class="nx">lockedUntil</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">(</span><span class="nb">Date</span><span class="p">.</span><span class="nx">now</span><span class="p">()</span> <span class="o">+</span> <span class="mi">30</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">);</span> <span class="c1">// 30 min lockout</span>
    <span class="k">await</span> <span class="nx">logAuthEvent</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="dl">'</span><span class="s1">ACCOUNT_LOCKED</span><span class="dl">'</span><span class="p">,</span> <span class="kc">false</span><span class="p">,</span> <span class="nx">req</span><span class="p">,</span> <span class="p">{</span> <span class="nx">email</span><span class="p">,</span> <span class="na">attempts</span><span class="p">:</span> <span class="nx">attempts</span><span class="p">.</span><span class="nx">count</span> <span class="p">});</span>
  <span class="p">}</span>
  
  <span class="nx">loginAttempts</span><span class="p">.</span><span class="kd">set</span><span class="p">(</span><span class="nx">email</span><span class="p">,</span> <span class="nx">attempts</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">async</span> <span class="kd">function</span> <span class="nx">clearLoginAttempts</span><span class="p">(</span><span class="nx">email</span><span class="p">:</span> <span class="kr">string</span><span class="p">):</span> <span class="nb">Promise</span><span class="o">&lt;</span><span class="k">void</span><span class="o">&gt;</span> <span class="p">{</span>
  <span class="nx">loginAttempts</span><span class="p">.</span><span class="k">delete</span><span class="p">(</span><span class="nx">email</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p><strong>Update login endpoint</strong> (line 279):</p>
<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">app</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="dl">'</span><span class="s1">/auth/login</span><span class="dl">'</span><span class="p">,</span> <span class="nx">authLimiter</span><span class="p">,</span> <span class="k">async</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">):</span> <span class="nb">Promise</span><span class="o">&lt;</span><span class="k">void</span><span class="o">&gt;</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="p">{</span> <span class="nx">email</span><span class="p">,</span> <span class="nx">password</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">;</span>
  
  <span class="c1">// Check lockout FIRST</span>
  <span class="k">if</span> <span class="p">(</span><span class="k">await</span> <span class="nx">checkAccountLockout</span><span class="p">(</span><span class="nx">email</span><span class="p">))</span> <span class="p">{</span>
    <span class="k">await</span> <span class="nx">logAuthEvent</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="dl">'</span><span class="s1">LOGIN_BLOCKED_LOCKOUT</span><span class="dl">'</span><span class="p">,</span> <span class="kc">false</span><span class="p">,</span> <span class="nx">req</span><span class="p">,</span> <span class="p">{</span> <span class="nx">email</span> <span class="p">});</span>
    <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">429</span><span class="p">).</span><span class="nx">json</span><span class="p">({</span> <span class="na">error</span><span class="p">:</span> <span class="dl">'</span><span class="s1">Account temporarily locked. Try again in 30 minutes.</span><span class="dl">'</span> <span class="p">});</span>
    <span class="k">return</span><span class="p">;</span>
  <span class="p">}</span>
  
  <span class="c1">// ... existing validation ...</span>
  
  <span class="c1">// On failed login (line 312):</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">passwordValid</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">await</span> <span class="nx">recordFailedLogin</span><span class="p">(</span><span class="nx">email</span><span class="p">);</span>
    <span class="k">await</span> <span class="nx">logAuthEvent</span><span class="p">(</span><span class="nx">user</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span> <span class="dl">'</span><span class="s1">LOGIN_ATTEMPT</span><span class="dl">'</span><span class="p">,</span> <span class="kc">false</span><span class="p">,</span> <span class="nx">req</span><span class="p">,</span> <span class="p">{</span> <span class="na">reason</span><span class="p">:</span> <span class="dl">'</span><span class="s1">invalid_password</span><span class="dl">'</span> <span class="p">});</span>
    <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">401</span><span class="p">).</span><span class="nx">json</span><span class="p">({</span> <span class="na">error</span><span class="p">:</span> <span class="dl">'</span><span class="s1">Invalid credentials</span><span class="dl">'</span> <span class="p">});</span>
    <span class="k">return</span><span class="p">;</span>
  <span class="p">}</span>
  
  <span class="c1">// On successful login (line 333):</span>
  <span class="k">await</span> <span class="nx">clearLoginAttempts</span><span class="p">(</span><span class="nx">email</span><span class="p">);</span>
  <span class="c1">// ... rest of success logic</span>
<span class="p">});</span>
</code></pre></div></div>

<h3 id="3-strengthen-password-requirements-ï¸">3. Strengthen Password Requirements âš ï¸</h3>

<p><strong>Status</strong>: âŒ Not Started<br />
<strong>Time</strong>: 2 hours<br />
<strong>Blocker</strong>: YES</p>

<p><strong>Create new file</strong> <code class="language-plaintext highlighter-rouge">services/auth-service/src/utils/password-validator.ts</code>:</p>
<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">export</span> <span class="kr">interface</span> <span class="nx">PasswordRequirements</span> <span class="p">{</span>
  <span class="nl">minLength</span><span class="p">:</span> <span class="kr">number</span><span class="p">;</span>
  <span class="nl">requireUppercase</span><span class="p">:</span> <span class="nx">boolean</span><span class="p">;</span>
  <span class="nl">requireLowercase</span><span class="p">:</span> <span class="nx">boolean</span><span class="p">;</span>
  <span class="nl">requireNumbers</span><span class="p">:</span> <span class="nx">boolean</span><span class="p">;</span>
  <span class="nl">requireSpecialChars</span><span class="p">:</span> <span class="nx">boolean</span><span class="p">;</span>
  <span class="nl">preventCommonPasswords</span><span class="p">:</span> <span class="nx">boolean</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">const</span> <span class="nx">COMMON_PASSWORDS</span> <span class="o">=</span> <span class="p">[</span>
  <span class="dl">'</span><span class="s1">password</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">12345678</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">qwerty</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">abc123</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">password123</span><span class="dl">'</span><span class="p">,</span>
  <span class="dl">'</span><span class="s1">admin</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">letmein</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">welcome</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">monkey</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">1234567890</span><span class="dl">'</span>
<span class="p">];</span>

<span class="k">export</span> <span class="kd">function</span> <span class="nx">validatePassword</span><span class="p">(</span><span class="nx">password</span><span class="p">:</span> <span class="kr">string</span><span class="p">):</span> <span class="p">{</span> <span class="nl">valid</span><span class="p">:</span> <span class="nx">boolean</span><span class="p">;</span> <span class="nl">errors</span><span class="p">:</span> <span class="kr">string</span><span class="p">[]</span> <span class="p">}</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="na">errors</span><span class="p">:</span> <span class="kr">string</span><span class="p">[]</span> <span class="o">=</span> <span class="p">[];</span>
  
  <span class="k">if</span> <span class="p">(</span><span class="nx">password</span><span class="p">.</span><span class="nx">length</span> <span class="o">&lt;</span> <span class="mi">12</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">errors</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="dl">'</span><span class="s1">Password must be at least 12 characters long</span><span class="dl">'</span><span class="p">);</span>
  <span class="p">}</span>
  
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="sr">/</span><span class="se">[</span><span class="sr">A-Z</span><span class="se">]</span><span class="sr">/</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">password</span><span class="p">))</span> <span class="p">{</span>
    <span class="nx">errors</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="dl">'</span><span class="s1">Password must contain at least one uppercase letter</span><span class="dl">'</span><span class="p">);</span>
  <span class="p">}</span>
  
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="sr">/</span><span class="se">[</span><span class="sr">a-z</span><span class="se">]</span><span class="sr">/</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">password</span><span class="p">))</span> <span class="p">{</span>
    <span class="nx">errors</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="dl">'</span><span class="s1">Password must contain at least one lowercase letter</span><span class="dl">'</span><span class="p">);</span>
  <span class="p">}</span>
  
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="sr">/</span><span class="se">[</span><span class="sr">0-9</span><span class="se">]</span><span class="sr">/</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">password</span><span class="p">))</span> <span class="p">{</span>
    <span class="nx">errors</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="dl">'</span><span class="s1">Password must contain at least one number</span><span class="dl">'</span><span class="p">);</span>
  <span class="p">}</span>
  
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="sr">/</span><span class="se">[</span><span class="sr">!@#$%^&amp;*()_+</span><span class="se">\-</span><span class="sr">=</span><span class="se">\[\]</span><span class="sr">{};':"</span><span class="se">\\</span><span class="sr">|,.&lt;&gt;</span><span class="se">\/</span><span class="sr">?</span><span class="se">]</span><span class="sr">/</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">password</span><span class="p">))</span> <span class="p">{</span>
    <span class="nx">errors</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="dl">'</span><span class="s1">Password must contain at least one special character</span><span class="dl">'</span><span class="p">);</span>
  <span class="p">}</span>
  
  <span class="kd">const</span> <span class="nx">lowerPassword</span> <span class="o">=</span> <span class="nx">password</span><span class="p">.</span><span class="nx">toLowerCase</span><span class="p">();</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">COMMON_PASSWORDS</span><span class="p">.</span><span class="nx">some</span><span class="p">(</span><span class="nx">common</span> <span class="o">=&gt;</span> <span class="nx">lowerPassword</span><span class="p">.</span><span class="nx">includes</span><span class="p">(</span><span class="nx">common</span><span class="p">)))</span> <span class="p">{</span>
    <span class="nx">errors</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="dl">'</span><span class="s1">Password is too common or contains common words</span><span class="dl">'</span><span class="p">);</span>
  <span class="p">}</span>
  
  <span class="k">return</span> <span class="p">{</span>
    <span class="na">valid</span><span class="p">:</span> <span class="nx">errors</span><span class="p">.</span><span class="nx">length</span> <span class="o">===</span> <span class="mi">0</span><span class="p">,</span>
    <span class="nx">errors</span>
  <span class="p">};</span>
<span class="p">}</span>
</code></pre></div></div>

<p><strong>Update registration endpoint</strong> (line 224):</p>
<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="p">{</span> <span class="nx">validatePassword</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">./utils/password-validator</span><span class="dl">'</span><span class="p">;</span>

<span class="nx">app</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="dl">'</span><span class="s1">/auth/register</span><span class="dl">'</span><span class="p">,</span> <span class="nx">authLimiter</span><span class="p">,</span> <span class="k">async</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">):</span> <span class="nb">Promise</span><span class="o">&lt;</span><span class="k">void</span><span class="o">&gt;</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="p">{</span> <span class="nx">email</span><span class="p">,</span> <span class="nx">password</span><span class="p">,</span> <span class="nx">firstName</span><span class="p">,</span> <span class="nx">lastName</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">;</span>
  
  <span class="c1">// Validate password strength</span>
  <span class="kd">const</span> <span class="nx">passwordValidation</span> <span class="o">=</span> <span class="nx">validatePassword</span><span class="p">(</span><span class="nx">password</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">passwordValidation</span><span class="p">.</span><span class="nx">valid</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">await</span> <span class="nx">logAuthEvent</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="dl">'</span><span class="s1">REGISTER_ATTEMPT</span><span class="dl">'</span><span class="p">,</span> <span class="kc">false</span><span class="p">,</span> <span class="nx">req</span><span class="p">,</span> <span class="p">{</span> 
      <span class="nx">email</span><span class="p">,</span> 
      <span class="na">reason</span><span class="p">:</span> <span class="dl">'</span><span class="s1">weak_password</span><span class="dl">'</span><span class="p">,</span>
      <span class="na">errors</span><span class="p">:</span> <span class="nx">passwordValidation</span><span class="p">.</span><span class="nx">errors</span> 
    <span class="p">});</span>
    <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">400</span><span class="p">).</span><span class="nx">json</span><span class="p">({</span> 
      <span class="na">error</span><span class="p">:</span> <span class="dl">'</span><span class="s1">Password does not meet requirements</span><span class="dl">'</span><span class="p">,</span>
      <span class="na">details</span><span class="p">:</span> <span class="nx">passwordValidation</span><span class="p">.</span><span class="nx">errors</span> 
    <span class="p">});</span>
    <span class="k">return</span><span class="p">;</span>
  <span class="p">}</span>
  
  <span class="c1">// ... rest of registration logic</span>
<span class="p">});</span>
</code></pre></div></div>

<h3 id="4-add-csrf-protection-ï¸">4. Add CSRF Protection âš ï¸</h3>

<p><strong>Status</strong>: âŒ Not Started<br />
<strong>Time</strong>: 2 hours<br />
<strong>Blocker</strong>: YES</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Install CSRF package</span>
<span class="nb">cd </span>services/auth-service
npm <span class="nb">install </span>csurf cookie-parser
npm <span class="nb">install</span> @types/csurf @types/cookie-parser <span class="nt">--save-dev</span>
</code></pre></div></div>

<p><strong>Update</strong> <code class="language-plaintext highlighter-rouge">services/auth-service/src/index.ts</code> (after line 59):</p>
<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nx">csrf</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">csurf</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="nx">cookieParser</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">cookie-parser</span><span class="dl">'</span><span class="p">;</span>

<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">cookieParser</span><span class="p">());</span>

<span class="c1">// CSRF protection for state-changing operations</span>
<span class="kd">const</span> <span class="nx">csrfProtection</span> <span class="o">=</span> <span class="nx">csrf</span><span class="p">({</span>
  <span class="na">cookie</span><span class="p">:</span> <span class="p">{</span>
    <span class="na">httpOnly</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
    <span class="na">secure</span><span class="p">:</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">NODE_ENV</span> <span class="o">===</span> <span class="dl">'</span><span class="s1">production</span><span class="dl">'</span><span class="p">,</span>
    <span class="na">sameSite</span><span class="p">:</span> <span class="dl">'</span><span class="s1">strict</span><span class="dl">'</span>
  <span class="p">}</span>
<span class="p">});</span>

<span class="c1">// Add CSRF token endpoint</span>
<span class="nx">app</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="dl">'</span><span class="s1">/auth/csrf-token</span><span class="dl">'</span><span class="p">,</span> <span class="nx">csrfProtection</span><span class="p">,</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">res</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span> <span class="na">csrfToken</span><span class="p">:</span> <span class="nx">req</span><span class="p">.</span><span class="nx">csrfToken</span><span class="p">()</span> <span class="p">});</span>
<span class="p">});</span>

<span class="c1">// Apply to state-changing endpoints</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="dl">'</span><span class="s1">/auth/register</span><span class="dl">'</span><span class="p">,</span> <span class="nx">csrfProtection</span><span class="p">,</span> <span class="nx">authLimiter</span><span class="p">,</span> <span class="k">async</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="c1">// ... existing logic</span>
<span class="p">});</span>

<span class="nx">app</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="dl">'</span><span class="s1">/auth/login</span><span class="dl">'</span><span class="p">,</span> <span class="nx">csrfProtection</span><span class="p">,</span> <span class="nx">authLimiter</span><span class="p">,</span> <span class="k">async</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="c1">// ... existing logic</span>
<span class="p">});</span>

<span class="nx">app</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="dl">'</span><span class="s1">/auth/logout</span><span class="dl">'</span><span class="p">,</span> <span class="nx">csrfProtection</span><span class="p">,</span> <span class="nx">authenticateToken</span><span class="p">,</span> <span class="k">async</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="c1">// ... logout logic</span>
<span class="p">});</span>
</code></pre></div></div>

<h3 id="5-fix-token-expiration-times-ï¸">5. Fix Token Expiration Times âš ï¸</h3>

<p><strong>Status</strong>: âŒ Not Started<br />
<strong>Time</strong>: 1 hour<br />
<strong>Blocker</strong>: YES</p>

<p><strong>Update</strong> <code class="language-plaintext highlighter-rouge">services/auth-service/src/index.ts</code> (lines 126-140):</p>
<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">function</span> <span class="nx">generateTokens</span><span class="p">(</span><span class="nx">userId</span><span class="p">:</span> <span class="kr">number</span><span class="p">,</span> <span class="nx">email</span><span class="p">:</span> <span class="kr">string</span><span class="p">,</span> <span class="nx">role</span><span class="p">:</span> <span class="kr">string</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">tokenId</span> <span class="o">=</span> <span class="nx">crypto</span><span class="p">.</span><span class="nx">randomBytes</span><span class="p">(</span><span class="mi">16</span><span class="p">).</span><span class="nx">toString</span><span class="p">(</span><span class="dl">'</span><span class="s1">hex</span><span class="dl">'</span><span class="p">);</span>
  
  <span class="kd">const</span> <span class="nx">accessToken</span> <span class="o">=</span> <span class="nx">jwt</span><span class="p">.</span><span class="nx">sign</span><span class="p">(</span>
    <span class="p">{</span> 
      <span class="nx">userId</span><span class="p">,</span> 
      <span class="nx">email</span><span class="p">,</span>
      <span class="nx">role</span><span class="p">,</span>
      <span class="na">type</span><span class="p">:</span> <span class="dl">'</span><span class="s1">access</span><span class="dl">'</span><span class="p">,</span>
      <span class="na">jti</span><span class="p">:</span> <span class="s2">`at_</span><span class="p">${</span><span class="nx">tokenId</span><span class="p">}</span><span class="s2">`</span><span class="p">,</span>
      <span class="na">iss</span><span class="p">:</span> <span class="dl">'</span><span class="s1">devmentor.app</span><span class="dl">'</span><span class="p">,</span>
      <span class="na">aud</span><span class="p">:</span> <span class="dl">'</span><span class="s1">devmentor-api</span><span class="dl">'</span>
    <span class="p">},</span>
    <span class="nx">JWT_SECRET</span><span class="p">,</span>
    <span class="p">{</span> <span class="na">expiresIn</span><span class="p">:</span> <span class="dl">'</span><span class="s1">15m</span><span class="dl">'</span> <span class="p">}</span> <span class="c1">// Changed from 15m to 15m (ensure it's exactly this)</span>
  <span class="p">);</span>
  
  <span class="kd">const</span> <span class="nx">refreshToken</span> <span class="o">=</span> <span class="nx">jwt</span><span class="p">.</span><span class="nx">sign</span><span class="p">(</span>
    <span class="p">{</span> 
      <span class="nx">userId</span><span class="p">,</span> 
      <span class="na">type</span><span class="p">:</span> <span class="dl">'</span><span class="s1">refresh</span><span class="dl">'</span><span class="p">,</span>
      <span class="na">jti</span><span class="p">:</span> <span class="s2">`rt_</span><span class="p">${</span><span class="nx">tokenId</span><span class="p">}</span><span class="s2">`</span><span class="p">,</span>
      <span class="na">iss</span><span class="p">:</span> <span class="dl">'</span><span class="s1">devmentor.app</span><span class="dl">'</span>
    <span class="p">},</span>
    <span class="nx">JWT_SECRET</span><span class="p">,</span>
    <span class="p">{</span> <span class="na">expiresIn</span><span class="p">:</span> <span class="dl">'</span><span class="s1">7d</span><span class="dl">'</span> <span class="p">}</span> <span class="c1">// Changed from 7d to exactly 7d</span>
  <span class="p">);</span>

  <span class="k">return</span> <span class="p">{</span> 
    <span class="nx">accessToken</span><span class="p">,</span> 
    <span class="nx">refreshToken</span><span class="p">,</span>
    <span class="na">expiresIn</span><span class="p">:</span> <span class="mi">900</span><span class="p">,</span> <span class="c1">// 15 minutes in seconds</span>
    <span class="na">tokenType</span><span class="p">:</span> <span class="dl">'</span><span class="s1">Bearer</span><span class="dl">'</span>
  <span class="p">};</span>
<span class="p">}</span>
</code></pre></div></div>

<hr />

<h2 id="-must-have---core-features-days-3-4">ğŸŸ¡ MUST HAVE - Core Features (Days 3-4)</h2>

<h3 id="6-email-verification-flow-">6. Email Verification Flow ğŸ“§</h3>

<p><strong>Status</strong>: âŒ Not Started<br />
<strong>Time</strong>: 4 hours<br />
<strong>Blocker</strong>: YES for production</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Install email service</span>
<span class="nb">cd </span>services/auth-service
npm <span class="nb">install</span> @sendgrid/mail
npm <span class="nb">install</span> <span class="nt">--save-dev</span> @types/node
</code></pre></div></div>

<p><strong>Create</strong> <code class="language-plaintext highlighter-rouge">services/auth-service/src/services/email.ts</code>:</p>
<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nx">sgMail</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">@sendgrid/mail</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="nx">crypto</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">crypto</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">redis</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">../redis</span><span class="dl">'</span><span class="p">;</span>

<span class="nx">sgMail</span><span class="p">.</span><span class="nx">setApiKey</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">SENDGRID_API_KEY</span> <span class="o">||</span> <span class="dl">''</span><span class="p">);</span>

<span class="k">export</span> <span class="kd">class</span> <span class="nx">EmailService</span> <span class="p">{</span>
  <span class="k">async</span> <span class="nx">sendVerificationEmail</span><span class="p">(</span><span class="nx">userId</span><span class="p">:</span> <span class="kr">number</span><span class="p">,</span> <span class="nx">email</span><span class="p">:</span> <span class="kr">string</span><span class="p">):</span> <span class="nb">Promise</span><span class="o">&lt;</span><span class="k">void</span><span class="o">&gt;</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">token</span> <span class="o">=</span> <span class="nx">crypto</span><span class="p">.</span><span class="nx">randomBytes</span><span class="p">(</span><span class="mi">32</span><span class="p">).</span><span class="nx">toString</span><span class="p">(</span><span class="dl">'</span><span class="s1">hex</span><span class="dl">'</span><span class="p">);</span>
    <span class="kd">const</span> <span class="nx">expiresIn</span> <span class="o">=</span> <span class="mi">3600</span><span class="p">;</span> <span class="c1">// 1 hour</span>
    
    <span class="c1">// Store token in Redis</span>
    <span class="k">await</span> <span class="nx">redis</span><span class="p">.</span><span class="nx">setex</span><span class="p">(</span><span class="s2">`email:verify:</span><span class="p">${</span><span class="nx">token</span><span class="p">}</span><span class="s2">`</span><span class="p">,</span> <span class="nx">expiresIn</span><span class="p">,</span> <span class="nx">userId</span><span class="p">.</span><span class="nx">toString</span><span class="p">());</span>
    
    <span class="kd">const</span> <span class="nx">verificationUrl</span> <span class="o">=</span> <span class="s2">`</span><span class="p">${</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">APP_URL</span><span class="p">}</span><span class="s2">/verify-email?token=</span><span class="p">${</span><span class="nx">token</span><span class="p">}</span><span class="s2">`</span><span class="p">;</span>
    
    <span class="kd">const</span> <span class="nx">msg</span> <span class="o">=</span> <span class="p">{</span>
      <span class="na">to</span><span class="p">:</span> <span class="nx">email</span><span class="p">,</span>
      <span class="na">from</span><span class="p">:</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">FROM_EMAIL</span> <span class="o">||</span> <span class="dl">'</span><span class="s1">noreply@devmentor.app</span><span class="dl">'</span><span class="p">,</span>
      <span class="na">subject</span><span class="p">:</span> <span class="dl">'</span><span class="s1">Verify your DevMentor account</span><span class="dl">'</span><span class="p">,</span>
      <span class="na">html</span><span class="p">:</span> <span class="s2">`
        &lt;!DOCTYPE html&gt;
        &lt;html&gt;
        &lt;head&gt;
          &lt;style&gt;
            .container { max-width: 600px; margin: 0 auto; font-family: Arial, sans-serif; }
            .header { background: #1e40af; color: white; padding: 20px; text-align: center; }
            .content { padding: 30px; background: #f9fafb; }
            .button { 
              display: inline-block; 
              padding: 12px 30px; 
              background: #3b82f6; 
              color: white; 
              text-decoration: none; 
              border-radius: 5px; 
              margin: 20px 0;
            }
            .footer { text-align: center; color: #6b7280; padding: 20px; font-size: 12px; }
          &lt;/style&gt;
        &lt;/head&gt;
        &lt;body&gt;
          &lt;div class="container"&gt;
            &lt;div class="header"&gt;
              &lt;h1&gt;Welcome to DevMentor!&lt;/h1&gt;
            &lt;/div&gt;
            &lt;div class="content"&gt;
              &lt;h2&gt;Verify Your Email Address&lt;/h2&gt;
              &lt;p&gt;Thank you for signing up! Please verify your email address to activate your account.&lt;/p&gt;
              &lt;a href="</span><span class="p">${</span><span class="nx">verificationUrl</span><span class="p">}</span><span class="s2">" class="button"&gt;Verify Email&lt;/a&gt;
              &lt;p style="color: #6b7280; font-size: 14px;"&gt;
                Or copy this link: &lt;br&gt;
                </span><span class="p">${</span><span class="nx">verificationUrl</span><span class="p">}</span><span class="s2">
              &lt;/p&gt;
              &lt;p style="color: #ef4444; font-size: 14px;"&gt;This link expires in 1 hour.&lt;/p&gt;
            &lt;/div&gt;
            &lt;div class="footer"&gt;
              &lt;p&gt;If you didn't create an account, please ignore this email.&lt;/p&gt;
              &lt;p&gt;&amp;copy; 2025 DevMentor. All rights reserved.&lt;/p&gt;
            &lt;/div&gt;
          &lt;/div&gt;
        &lt;/body&gt;
        &lt;/html&gt;
      `</span>
    <span class="p">};</span>
    
    <span class="k">try</span> <span class="p">{</span>
      <span class="k">await</span> <span class="nx">sgMail</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="nx">msg</span><span class="p">);</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">`Verification email sent to </span><span class="p">${</span><span class="nx">email</span><span class="p">}</span><span class="s2">`</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="dl">'</span><span class="s1">Failed to send verification email:</span><span class="dl">'</span><span class="p">,</span> <span class="nx">error</span><span class="p">);</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="dl">'</span><span class="s1">Failed to send verification email</span><span class="dl">'</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>
  
  <span class="k">async</span> <span class="nx">verifyEmail</span><span class="p">(</span><span class="nx">token</span><span class="p">:</span> <span class="kr">string</span><span class="p">):</span> <span class="nb">Promise</span><span class="o">&lt;</span><span class="kr">number</span> <span class="o">|</span> <span class="kc">null</span><span class="o">&gt;</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">userId</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">redis</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="s2">`email:verify:</span><span class="p">${</span><span class="nx">token</span><span class="p">}</span><span class="s2">`</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">userId</span><span class="p">)</span> <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
    
    <span class="k">await</span> <span class="nx">redis</span><span class="p">.</span><span class="nx">del</span><span class="p">(</span><span class="s2">`email:verify:</span><span class="p">${</span><span class="nx">token</span><span class="p">}</span><span class="s2">`</span><span class="p">);</span>
    <span class="k">return</span> <span class="nb">parseInt</span><span class="p">(</span><span class="nx">userId</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p><strong>Add verification endpoints</strong> to <code class="language-plaintext highlighter-rouge">services/auth-service/src/index.ts</code>:</p>
<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="p">{</span> <span class="nx">EmailService</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">./services/email</span><span class="dl">'</span><span class="p">;</span>
<span class="kd">const</span> <span class="nx">emailService</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">EmailService</span><span class="p">();</span>

<span class="c1">// Send verification email after registration (line 268)</span>
<span class="k">await</span> <span class="nx">emailService</span><span class="p">.</span><span class="nx">sendVerificationEmail</span><span class="p">(</span><span class="nx">user</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span> <span class="nx">email</span><span class="p">);</span>

<span class="c1">// Add verification endpoint</span>
<span class="nx">app</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="dl">'</span><span class="s1">/auth/verify-email</span><span class="dl">'</span><span class="p">,</span> <span class="k">async</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">):</span> <span class="nb">Promise</span><span class="o">&lt;</span><span class="k">void</span><span class="o">&gt;</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="p">{</span> <span class="nx">token</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">query</span><span class="p">;</span>
  
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">token</span> <span class="o">||</span> <span class="k">typeof</span> <span class="nx">token</span> <span class="o">!==</span> <span class="dl">'</span><span class="s1">string</span><span class="dl">'</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">400</span><span class="p">).</span><span class="nx">json</span><span class="p">({</span> <span class="na">error</span><span class="p">:</span> <span class="dl">'</span><span class="s1">Invalid verification token</span><span class="dl">'</span> <span class="p">});</span>
    <span class="k">return</span><span class="p">;</span>
  <span class="p">}</span>
  
  <span class="k">try</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">userId</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">emailService</span><span class="p">.</span><span class="nx">verifyEmail</span><span class="p">(</span><span class="nx">token</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">userId</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">400</span><span class="p">).</span><span class="nx">json</span><span class="p">({</span> <span class="na">error</span><span class="p">:</span> <span class="dl">'</span><span class="s1">Invalid or expired token</span><span class="dl">'</span> <span class="p">});</span>
      <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>
    
    <span class="k">await</span> <span class="nx">pool</span><span class="p">.</span><span class="nx">query</span><span class="p">(</span><span class="dl">'</span><span class="s1">UPDATE users SET email_verified = true WHERE id = $1</span><span class="dl">'</span><span class="p">,</span> <span class="p">[</span><span class="nx">userId</span><span class="p">]);</span>
    <span class="k">await</span> <span class="nx">logAuthEvent</span><span class="p">(</span><span class="nx">userId</span><span class="p">,</span> <span class="dl">'</span><span class="s1">EMAIL_VERIFIED</span><span class="dl">'</span><span class="p">,</span> <span class="kc">true</span><span class="p">,</span> <span class="nx">req</span><span class="p">);</span>
    
    <span class="nx">res</span><span class="p">.</span><span class="nx">redirect</span><span class="p">(</span><span class="dl">'</span><span class="s1">/login?verified=true</span><span class="dl">'</span><span class="p">);</span>
  <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">logger</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="dl">'</span><span class="s1">Email verification error:</span><span class="dl">'</span><span class="p">,</span> <span class="nx">error</span><span class="p">);</span>
    <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">500</span><span class="p">).</span><span class="nx">json</span><span class="p">({</span> <span class="na">error</span><span class="p">:</span> <span class="dl">'</span><span class="s1">Verification failed</span><span class="dl">'</span> <span class="p">});</span>
  <span class="p">}</span>
<span class="p">});</span>

<span class="c1">// Resend verification</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="dl">'</span><span class="s1">/auth/resend-verification</span><span class="dl">'</span><span class="p">,</span> <span class="nx">authenticateToken</span><span class="p">,</span> <span class="k">async</span> <span class="p">(</span><span class="nx">req</span><span class="p">:</span> <span class="kr">any</span><span class="p">,</span> <span class="nx">res</span><span class="p">):</span> <span class="nb">Promise</span><span class="o">&lt;</span><span class="k">void</span><span class="o">&gt;</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="k">try</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">user</span><span class="p">.</span><span class="nx">email_verified</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">400</span><span class="p">).</span><span class="nx">json</span><span class="p">({</span> <span class="na">error</span><span class="p">:</span> <span class="dl">'</span><span class="s1">Email already verified</span><span class="dl">'</span> <span class="p">});</span>
      <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>
    
    <span class="k">await</span> <span class="nx">emailService</span><span class="p">.</span><span class="nx">sendVerificationEmail</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">user</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span> <span class="nx">req</span><span class="p">.</span><span class="nx">user</span><span class="p">.</span><span class="nx">email</span><span class="p">);</span>
    <span class="nx">res</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span> <span class="na">message</span><span class="p">:</span> <span class="dl">'</span><span class="s1">Verification email sent</span><span class="dl">'</span> <span class="p">});</span>
  <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">500</span><span class="p">).</span><span class="nx">json</span><span class="p">({</span> <span class="na">error</span><span class="p">:</span> <span class="dl">'</span><span class="s1">Failed to send verification email</span><span class="dl">'</span> <span class="p">});</span>
  <span class="p">}</span>
<span class="p">});</span>

<span class="c1">// Block login if not verified (update login endpoint line 295)</span>
<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">user</span><span class="p">.</span><span class="nx">email_verified</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">await</span> <span class="nx">logAuthEvent</span><span class="p">(</span><span class="nx">user</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span> <span class="dl">'</span><span class="s1">LOGIN_BLOCKED_UNVERIFIED</span><span class="dl">'</span><span class="p">,</span> <span class="kc">false</span><span class="p">,</span> <span class="nx">req</span><span class="p">);</span>
  <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">403</span><span class="p">).</span><span class="nx">json</span><span class="p">({</span> 
    <span class="na">error</span><span class="p">:</span> <span class="dl">'</span><span class="s1">Email not verified</span><span class="dl">'</span><span class="p">,</span>
    <span class="na">code</span><span class="p">:</span> <span class="dl">'</span><span class="s1">EMAIL_NOT_VERIFIED</span><span class="dl">'</span><span class="p">,</span>
    <span class="na">resendUrl</span><span class="p">:</span> <span class="dl">'</span><span class="s1">/auth/resend-verification</span><span class="dl">'</span>
  <span class="p">});</span>
  <span class="k">return</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<h3 id="7-password-reset-flow-">7. Password Reset Flow ğŸ”‘</h3>

<p><strong>Status</strong>: âŒ Not Started<br />
<strong>Time</strong>: 3 hours<br />
<strong>Blocker</strong>: YES for production</p>

<p><strong>Add to</strong> <code class="language-plaintext highlighter-rouge">services/auth-service/src/services/email.ts</code>:</p>
<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">export</span> <span class="kd">class</span> <span class="nx">EmailService</span> <span class="p">{</span>
  <span class="c1">// ... existing code ...</span>
  
  <span class="k">async</span> <span class="nx">sendPasswordResetEmail</span><span class="p">(</span><span class="nx">userId</span><span class="p">:</span> <span class="kr">number</span><span class="p">,</span> <span class="nx">email</span><span class="p">:</span> <span class="kr">string</span><span class="p">):</span> <span class="nb">Promise</span><span class="o">&lt;</span><span class="k">void</span><span class="o">&gt;</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">token</span> <span class="o">=</span> <span class="nx">crypto</span><span class="p">.</span><span class="nx">randomBytes</span><span class="p">(</span><span class="mi">32</span><span class="p">).</span><span class="nx">toString</span><span class="p">(</span><span class="dl">'</span><span class="s1">hex</span><span class="dl">'</span><span class="p">);</span>
    <span class="kd">const</span> <span class="nx">expiresIn</span> <span class="o">=</span> <span class="mi">3600</span><span class="p">;</span> <span class="c1">// 1 hour</span>
    
    <span class="k">await</span> <span class="nx">redis</span><span class="p">.</span><span class="nx">setex</span><span class="p">(</span><span class="s2">`password:reset:</span><span class="p">${</span><span class="nx">token</span><span class="p">}</span><span class="s2">`</span><span class="p">,</span> <span class="nx">expiresIn</span><span class="p">,</span> <span class="nx">userId</span><span class="p">.</span><span class="nx">toString</span><span class="p">());</span>
    
    <span class="kd">const</span> <span class="nx">resetUrl</span> <span class="o">=</span> <span class="s2">`</span><span class="p">${</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">APP_URL</span><span class="p">}</span><span class="s2">/reset-password?token=</span><span class="p">${</span><span class="nx">token</span><span class="p">}</span><span class="s2">`</span><span class="p">;</span>
    
    <span class="kd">const</span> <span class="nx">msg</span> <span class="o">=</span> <span class="p">{</span>
      <span class="na">to</span><span class="p">:</span> <span class="nx">email</span><span class="p">,</span>
      <span class="na">from</span><span class="p">:</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">FROM_EMAIL</span> <span class="o">||</span> <span class="dl">'</span><span class="s1">noreply@devmentor.app</span><span class="dl">'</span><span class="p">,</span>
      <span class="na">subject</span><span class="p">:</span> <span class="dl">'</span><span class="s1">Reset your DevMentor password</span><span class="dl">'</span><span class="p">,</span>
      <span class="na">html</span><span class="p">:</span> <span class="s2">`
        &lt;!DOCTYPE html&gt;
        &lt;html&gt;
        &lt;head&gt;
          &lt;style&gt;
            .container { max-width: 600px; margin: 0 auto; font-family: Arial, sans-serif; }
            .header { background: #dc2626; color: white; padding: 20px; text-align: center; }
            .content { padding: 30px; background: #f9fafb; }
            .button { 
              display: inline-block; 
              padding: 12px 30px; 
              background: #dc2626; 
              color: white; 
              text-decoration: none; 
              border-radius: 5px; 
              margin: 20px 0;
            }
            .footer { text-align: center; color: #6b7280; padding: 20px; font-size: 12px; }
          &lt;/style&gt;
        &lt;/head&gt;
        &lt;body&gt;
          &lt;div class="container"&gt;
            &lt;div class="header"&gt;
              &lt;h1&gt;Password Reset Request&lt;/h1&gt;
            &lt;/div&gt;
            &lt;div class="content"&gt;
              &lt;h2&gt;Reset Your Password&lt;/h2&gt;
              &lt;p&gt;We received a request to reset your password. Click the button below to create a new password.&lt;/p&gt;
              &lt;a href="</span><span class="p">${</span><span class="nx">resetUrl</span><span class="p">}</span><span class="s2">" class="button"&gt;Reset Password&lt;/a&gt;
              &lt;p style="color: #6b7280; font-size: 14px;"&gt;
                Or copy this link: &lt;br&gt;
                </span><span class="p">${</span><span class="nx">resetUrl</span><span class="p">}</span><span class="s2">
              &lt;/p&gt;
              &lt;p style="color: #ef4444; font-size: 14px;"&gt;This link expires in 1 hour.&lt;/p&gt;
              &lt;p style="margin-top: 30px; padding: 15px; background: #fef2f2; border-left: 4px solid #dc2626;"&gt;
                &lt;strong&gt;Security Notice:&lt;/strong&gt; If you didn't request this reset, please ignore this email and your password will remain unchanged.
              &lt;/p&gt;
            &lt;/div&gt;
            &lt;div class="footer"&gt;
              &lt;p&gt;&amp;copy; 2025 DevMentor. All rights reserved.&lt;/p&gt;
            &lt;/div&gt;
          &lt;/div&gt;
        &lt;/body&gt;
        &lt;/html&gt;
      `</span>
    <span class="p">};</span>
    
    <span class="k">await</span> <span class="nx">sgMail</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="nx">msg</span><span class="p">);</span>
  <span class="p">}</span>
  
  <span class="k">async</span> <span class="nx">validateResetToken</span><span class="p">(</span><span class="nx">token</span><span class="p">:</span> <span class="kr">string</span><span class="p">):</span> <span class="nb">Promise</span><span class="o">&lt;</span><span class="kr">number</span> <span class="o">|</span> <span class="kc">null</span><span class="o">&gt;</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">userId</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">redis</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="s2">`password:reset:</span><span class="p">${</span><span class="nx">token</span><span class="p">}</span><span class="s2">`</span><span class="p">);</span>
    <span class="k">return</span> <span class="nx">userId</span> <span class="p">?</span> <span class="nb">parseInt</span><span class="p">(</span><span class="nx">userId</span><span class="p">)</span> <span class="p">:</span> <span class="kc">null</span><span class="p">;</span>
  <span class="p">}</span>
  
  <span class="k">async</span> <span class="nx">consumeResetToken</span><span class="p">(</span><span class="nx">token</span><span class="p">:</span> <span class="kr">string</span><span class="p">):</span> <span class="nb">Promise</span><span class="o">&lt;</span><span class="kr">number</span> <span class="o">|</span> <span class="kc">null</span><span class="o">&gt;</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">userId</span> <span class="o">=</span> <span class="k">await</span> <span class="k">this</span><span class="p">.</span><span class="nx">validateResetToken</span><span class="p">(</span><span class="nx">token</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">userId</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">await</span> <span class="nx">redis</span><span class="p">.</span><span class="nx">del</span><span class="p">(</span><span class="s2">`password:reset:</span><span class="p">${</span><span class="nx">token</span><span class="p">}</span><span class="s2">`</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">userId</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p><strong>Add password reset endpoints</strong> to <code class="language-plaintext highlighter-rouge">services/auth-service/src/index.ts</code>:</p>
<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Request password reset</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="dl">'</span><span class="s1">/auth/forgot-password</span><span class="dl">'</span><span class="p">,</span> <span class="nx">authLimiter</span><span class="p">,</span> <span class="k">async</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">):</span> <span class="nb">Promise</span><span class="o">&lt;</span><span class="k">void</span><span class="o">&gt;</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="p">{</span> <span class="nx">email</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">;</span>
  
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">email</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">400</span><span class="p">).</span><span class="nx">json</span><span class="p">({</span> <span class="na">error</span><span class="p">:</span> <span class="dl">'</span><span class="s1">Email is required</span><span class="dl">'</span> <span class="p">});</span>
    <span class="k">return</span><span class="p">;</span>
  <span class="p">}</span>
  
  <span class="k">try</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">userResult</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">pool</span><span class="p">.</span><span class="nx">query</span><span class="p">(</span><span class="dl">'</span><span class="s1">SELECT id FROM users WHERE email = $1</span><span class="dl">'</span><span class="p">,</span> <span class="p">[</span><span class="nx">email</span><span class="p">]);</span>
    
    <span class="k">if</span> <span class="p">(</span><span class="nx">userResult</span><span class="p">.</span><span class="nx">rows</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">const</span> <span class="nx">user</span> <span class="o">=</span> <span class="nx">userResult</span><span class="p">.</span><span class="nx">rows</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
      <span class="k">await</span> <span class="nx">emailService</span><span class="p">.</span><span class="nx">sendPasswordResetEmail</span><span class="p">(</span><span class="nx">user</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span> <span class="nx">email</span><span class="p">);</span>
      <span class="k">await</span> <span class="nx">logAuthEvent</span><span class="p">(</span><span class="nx">user</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span> <span class="dl">'</span><span class="s1">PASSWORD_RESET_REQUESTED</span><span class="dl">'</span><span class="p">,</span> <span class="kc">true</span><span class="p">,</span> <span class="nx">req</span><span class="p">);</span>
    <span class="p">}</span>
    
    <span class="c1">// Always return success to prevent email enumeration</span>
    <span class="nx">res</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span> 
      <span class="na">message</span><span class="p">:</span> <span class="dl">'</span><span class="s1">If an account exists with this email, a password reset link has been sent.</span><span class="dl">'</span> 
    <span class="p">});</span>
  <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">logger</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="dl">'</span><span class="s1">Password reset request error:</span><span class="dl">'</span><span class="p">,</span> <span class="nx">error</span><span class="p">);</span>
    <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">500</span><span class="p">).</span><span class="nx">json</span><span class="p">({</span> <span class="na">error</span><span class="p">:</span> <span class="dl">'</span><span class="s1">Failed to process request</span><span class="dl">'</span> <span class="p">});</span>
  <span class="p">}</span>
<span class="p">});</span>

<span class="c1">// Validate reset token</span>
<span class="nx">app</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="dl">'</span><span class="s1">/auth/validate-reset-token</span><span class="dl">'</span><span class="p">,</span> <span class="k">async</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">):</span> <span class="nb">Promise</span><span class="o">&lt;</span><span class="k">void</span><span class="o">&gt;</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="p">{</span> <span class="nx">token</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">query</span><span class="p">;</span>
  
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">token</span> <span class="o">||</span> <span class="k">typeof</span> <span class="nx">token</span> <span class="o">!==</span> <span class="dl">'</span><span class="s1">string</span><span class="dl">'</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">400</span><span class="p">).</span><span class="nx">json</span><span class="p">({</span> <span class="na">valid</span><span class="p">:</span> <span class="kc">false</span> <span class="p">});</span>
    <span class="k">return</span><span class="p">;</span>
  <span class="p">}</span>
  
  <span class="kd">const</span> <span class="nx">userId</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">emailService</span><span class="p">.</span><span class="nx">validateResetToken</span><span class="p">(</span><span class="nx">token</span><span class="p">);</span>
  <span class="nx">res</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span> <span class="na">valid</span><span class="p">:</span> <span class="o">!!</span><span class="nx">userId</span> <span class="p">});</span>
<span class="p">});</span>

<span class="c1">// Reset password</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="dl">'</span><span class="s1">/auth/reset-password</span><span class="dl">'</span><span class="p">,</span> <span class="k">async</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">):</span> <span class="nb">Promise</span><span class="o">&lt;</span><span class="k">void</span><span class="o">&gt;</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="p">{</span> <span class="nx">token</span><span class="p">,</span> <span class="nx">newPassword</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">;</span>
  
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">token</span> <span class="o">||</span> <span class="o">!</span><span class="nx">newPassword</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">400</span><span class="p">).</span><span class="nx">json</span><span class="p">({</span> <span class="na">error</span><span class="p">:</span> <span class="dl">'</span><span class="s1">Token and new password are required</span><span class="dl">'</span> <span class="p">});</span>
    <span class="k">return</span><span class="p">;</span>
  <span class="p">}</span>
  
  <span class="c1">// Validate new password</span>
  <span class="kd">const</span> <span class="nx">passwordValidation</span> <span class="o">=</span> <span class="nx">validatePassword</span><span class="p">(</span><span class="nx">newPassword</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">passwordValidation</span><span class="p">.</span><span class="nx">valid</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">400</span><span class="p">).</span><span class="nx">json</span><span class="p">({</span> 
      <span class="na">error</span><span class="p">:</span> <span class="dl">'</span><span class="s1">Password does not meet requirements</span><span class="dl">'</span><span class="p">,</span>
      <span class="na">details</span><span class="p">:</span> <span class="nx">passwordValidation</span><span class="p">.</span><span class="nx">errors</span> 
    <span class="p">});</span>
    <span class="k">return</span><span class="p">;</span>
  <span class="p">}</span>
  
  <span class="k">try</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">userId</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">emailService</span><span class="p">.</span><span class="nx">consumeResetToken</span><span class="p">(</span><span class="nx">token</span><span class="p">);</span>
    
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">userId</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">400</span><span class="p">).</span><span class="nx">json</span><span class="p">({</span> <span class="na">error</span><span class="p">:</span> <span class="dl">'</span><span class="s1">Invalid or expired reset token</span><span class="dl">'</span> <span class="p">});</span>
      <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>
    
    <span class="kd">const</span> <span class="nx">passwordHash</span> <span class="o">=</span> <span class="nx">hashPassword</span><span class="p">(</span><span class="nx">newPassword</span><span class="p">);</span>
    
    <span class="k">await</span> <span class="nx">pool</span><span class="p">.</span><span class="nx">query</span><span class="p">(</span><span class="dl">'</span><span class="s1">UPDATE users SET password_hash = $1 WHERE id = $2</span><span class="dl">'</span><span class="p">,</span> <span class="p">[</span><span class="nx">passwordHash</span><span class="p">,</span> <span class="nx">userId</span><span class="p">]);</span>
    
    <span class="c1">// Revoke all existing sessions</span>
    <span class="k">await</span> <span class="nx">pool</span><span class="p">.</span><span class="nx">query</span><span class="p">(</span><span class="dl">'</span><span class="s1">DELETE FROM user_sessions WHERE user_id = $1</span><span class="dl">'</span><span class="p">,</span> <span class="p">[</span><span class="nx">userId</span><span class="p">]);</span>
    
    <span class="k">await</span> <span class="nx">logAuthEvent</span><span class="p">(</span><span class="nx">userId</span><span class="p">,</span> <span class="dl">'</span><span class="s1">PASSWORD_RESET_COMPLETED</span><span class="dl">'</span><span class="p">,</span> <span class="kc">true</span><span class="p">,</span> <span class="nx">req</span><span class="p">);</span>
    
    <span class="nx">res</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span> <span class="na">message</span><span class="p">:</span> <span class="dl">'</span><span class="s1">Password reset successful. Please login with your new password.</span><span class="dl">'</span> <span class="p">});</span>
  <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">logger</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="dl">'</span><span class="s1">Password reset error:</span><span class="dl">'</span><span class="p">,</span> <span class="nx">error</span><span class="p">);</span>
    <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">500</span><span class="p">).</span><span class="nx">json</span><span class="p">({</span> <span class="na">error</span><span class="p">:</span> <span class="dl">'</span><span class="s1">Failed to reset password</span><span class="dl">'</span> <span class="p">});</span>
  <span class="p">}</span>
<span class="p">});</span>
</code></pre></div></div>

<h3 id="8-basic-rbac-implementation-">8. Basic RBAC Implementation ğŸ‘¥</h3>

<p><strong>Status</strong>: âŒ Not Started<br />
<strong>Time</strong>: 3 hours<br />
<strong>Blocker</strong>: Medium priority</p>

<p><strong>Create</strong> <code class="language-plaintext highlighter-rouge">services/auth-service/src/middleware/rbac.ts</code>:</p>
<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">export</span> <span class="kr">enum</span> <span class="nx">Role</span> <span class="p">{</span>
  <span class="nx">USER</span> <span class="o">=</span> <span class="dl">'</span><span class="s1">user</span><span class="dl">'</span><span class="p">,</span>
  <span class="nx">ADMIN</span> <span class="o">=</span> <span class="dl">'</span><span class="s1">admin</span><span class="dl">'</span><span class="p">,</span>
  <span class="nx">MODERATOR</span> <span class="o">=</span> <span class="dl">'</span><span class="s1">moderator</span><span class="dl">'</span>
<span class="p">}</span>

<span class="k">export</span> <span class="kr">enum</span> <span class="nx">Permission</span> <span class="p">{</span>
  <span class="c1">// User permissions</span>
  <span class="nx">READ_OWN_PROFILE</span> <span class="o">=</span> <span class="dl">'</span><span class="s1">profile:read:own</span><span class="dl">'</span><span class="p">,</span>
  <span class="nx">WRITE_OWN_PROFILE</span> <span class="o">=</span> <span class="dl">'</span><span class="s1">profile:write:own</span><span class="dl">'</span><span class="p">,</span>
  <span class="nx">DELETE_OWN_ACCOUNT</span> <span class="o">=</span> <span class="dl">'</span><span class="s1">account:delete:own</span><span class="dl">'</span><span class="p">,</span>
  
  <span class="c1">// Moderator permissions</span>
  <span class="nx">READ_ALL_PROJECTS</span> <span class="o">=</span> <span class="dl">'</span><span class="s1">projects:read:all</span><span class="dl">'</span><span class="p">,</span>
  <span class="nx">MODERATE_CONTENT</span> <span class="o">=</span> <span class="dl">'</span><span class="s1">content:moderate</span><span class="dl">'</span><span class="p">,</span>
  <span class="nx">VIEW_REPORTS</span> <span class="o">=</span> <span class="dl">'</span><span class="s1">reports:view</span><span class="dl">'</span><span class="p">,</span>
  
  <span class="c1">// Admin permissions</span>
  <span class="nx">READ_ALL_USERS</span> <span class="o">=</span> <span class="dl">'</span><span class="s1">users:read:all</span><span class="dl">'</span><span class="p">,</span>
  <span class="nx">WRITE_ALL_USERS</span> <span class="o">=</span> <span class="dl">'</span><span class="s1">users:write:all</span><span class="dl">'</span><span class="p">,</span>
  <span class="nx">DELETE_ALL_USERS</span> <span class="o">=</span> <span class="dl">'</span><span class="s1">users:delete:all</span><span class="dl">'</span><span class="p">,</span>
  <span class="nx">MANAGE_ROLES</span> <span class="o">=</span> <span class="dl">'</span><span class="s1">roles:manage</span><span class="dl">'</span><span class="p">,</span>
  <span class="nx">VIEW_ANALYTICS</span> <span class="o">=</span> <span class="dl">'</span><span class="s1">analytics:view</span><span class="dl">'</span><span class="p">,</span>
  <span class="nx">SYSTEM_CONFIG</span> <span class="o">=</span> <span class="dl">'</span><span class="s1">system:config</span><span class="dl">'</span>
<span class="p">}</span>

<span class="kd">const</span> <span class="nx">rolePermissions</span><span class="p">:</span> <span class="nb">Record</span><span class="o">&lt;</span><span class="nx">Role</span><span class="p">,</span> <span class="nx">Permission</span><span class="p">[]</span><span class="o">&gt;</span> <span class="o">=</span> <span class="p">{</span>
  <span class="p">[</span><span class="nx">Role</span><span class="p">.</span><span class="nx">USER</span><span class="p">]:</span> <span class="p">[</span>
    <span class="nx">Permission</span><span class="p">.</span><span class="nx">READ_OWN_PROFILE</span><span class="p">,</span>
    <span class="nx">Permission</span><span class="p">.</span><span class="nx">WRITE_OWN_PROFILE</span><span class="p">,</span>
    <span class="nx">Permission</span><span class="p">.</span><span class="nx">DELETE_OWN_ACCOUNT</span>
  <span class="p">],</span>
  <span class="p">[</span><span class="nx">Role</span><span class="p">.</span><span class="nx">MODERATOR</span><span class="p">]:</span> <span class="p">[</span>
    <span class="nx">Permission</span><span class="p">.</span><span class="nx">READ_OWN_PROFILE</span><span class="p">,</span>
    <span class="nx">Permission</span><span class="p">.</span><span class="nx">WRITE_OWN_PROFILE</span><span class="p">,</span>
    <span class="nx">Permission</span><span class="p">.</span><span class="nx">DELETE_OWN_ACCOUNT</span><span class="p">,</span>
    <span class="nx">Permission</span><span class="p">.</span><span class="nx">READ_ALL_PROJECTS</span><span class="p">,</span>
    <span class="nx">Permission</span><span class="p">.</span><span class="nx">MODERATE_CONTENT</span><span class="p">,</span>
    <span class="nx">Permission</span><span class="p">.</span><span class="nx">VIEW_REPORTS</span>
  <span class="p">],</span>
  <span class="p">[</span><span class="nx">Role</span><span class="p">.</span><span class="nx">ADMIN</span><span class="p">]:</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">values</span><span class="p">(</span><span class="nx">Permission</span><span class="p">)</span> <span class="c1">// All permissions</span>
<span class="p">};</span>

<span class="k">export</span> <span class="kd">function</span> <span class="nx">hasPermission</span><span class="p">(</span><span class="nx">userRole</span><span class="p">:</span> <span class="kr">string</span><span class="p">,</span> <span class="nx">requiredPermission</span><span class="p">:</span> <span class="nx">Permission</span><span class="p">):</span> <span class="nx">boolean</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">role</span> <span class="o">=</span> <span class="nx">userRole</span> <span class="k">as</span> <span class="nx">Role</span><span class="p">;</span>
  <span class="kd">const</span> <span class="nx">permissions</span> <span class="o">=</span> <span class="nx">rolePermissions</span><span class="p">[</span><span class="nx">role</span><span class="p">]</span> <span class="o">||</span> <span class="p">[];</span>
  <span class="k">return</span> <span class="nx">permissions</span><span class="p">.</span><span class="nx">includes</span><span class="p">(</span><span class="nx">requiredPermission</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">export</span> <span class="kd">function</span> <span class="nx">requirePermission</span><span class="p">(</span><span class="nx">permission</span><span class="p">:</span> <span class="nx">Permission</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="p">(</span><span class="nx">req</span><span class="p">:</span> <span class="kr">any</span><span class="p">,</span> <span class="nx">res</span><span class="p">:</span> <span class="kr">any</span><span class="p">,</span> <span class="nx">next</span><span class="p">:</span> <span class="kr">any</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">req</span><span class="p">.</span><span class="nx">user</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">401</span><span class="p">).</span><span class="nx">json</span><span class="p">({</span> <span class="na">error</span><span class="p">:</span> <span class="dl">'</span><span class="s1">Authentication required</span><span class="dl">'</span> <span class="p">});</span>
    <span class="p">}</span>
    
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">hasPermission</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">user</span><span class="p">.</span><span class="nx">role</span><span class="p">,</span> <span class="nx">permission</span><span class="p">))</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">403</span><span class="p">).</span><span class="nx">json</span><span class="p">({</span> 
        <span class="na">error</span><span class="p">:</span> <span class="dl">'</span><span class="s1">Insufficient permissions</span><span class="dl">'</span><span class="p">,</span>
        <span class="na">required</span><span class="p">:</span> <span class="nx">permission</span><span class="p">,</span>
        <span class="na">userRole</span><span class="p">:</span> <span class="nx">req</span><span class="p">.</span><span class="nx">user</span><span class="p">.</span><span class="nx">role</span>
      <span class="p">});</span>
    <span class="p">}</span>
    
    <span class="nx">next</span><span class="p">();</span>
  <span class="p">};</span>
<span class="p">}</span>

<span class="k">export</span> <span class="kd">function</span> <span class="nx">requireRole</span><span class="p">(</span><span class="nx">role</span><span class="p">:</span> <span class="nx">Role</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="p">(</span><span class="nx">req</span><span class="p">:</span> <span class="kr">any</span><span class="p">,</span> <span class="nx">res</span><span class="p">:</span> <span class="kr">any</span><span class="p">,</span> <span class="nx">next</span><span class="p">:</span> <span class="kr">any</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">req</span><span class="p">.</span><span class="nx">user</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">401</span><span class="p">).</span><span class="nx">json</span><span class="p">({</span> <span class="na">error</span><span class="p">:</span> <span class="dl">'</span><span class="s1">Authentication required</span><span class="dl">'</span> <span class="p">});</span>
    <span class="p">}</span>
    
    <span class="k">if</span> <span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">user</span><span class="p">.</span><span class="nx">role</span> <span class="o">!==</span> <span class="nx">role</span> <span class="o">&amp;&amp;</span> <span class="nx">req</span><span class="p">.</span><span class="nx">user</span><span class="p">.</span><span class="nx">role</span> <span class="o">!==</span> <span class="nx">Role</span><span class="p">.</span><span class="nx">ADMIN</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">403</span><span class="p">).</span><span class="nx">json</span><span class="p">({</span> 
        <span class="na">error</span><span class="p">:</span> <span class="dl">'</span><span class="s1">Insufficient role</span><span class="dl">'</span><span class="p">,</span>
        <span class="na">required</span><span class="p">:</span> <span class="nx">role</span><span class="p">,</span>
        <span class="na">userRole</span><span class="p">:</span> <span class="nx">req</span><span class="p">.</span><span class="nx">user</span><span class="p">.</span><span class="nx">role</span>
      <span class="p">});</span>
    <span class="p">}</span>
    
    <span class="nx">next</span><span class="p">();</span>
  <span class="p">};</span>
<span class="p">}</span>
</code></pre></div></div>

<p><strong>Add admin endpoints</strong> to <code class="language-plaintext highlighter-rouge">services/auth-service/src/index.ts</code>:</p>
<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="p">{</span> <span class="nx">requirePermission</span><span class="p">,</span> <span class="nx">requireRole</span><span class="p">,</span> <span class="nx">Permission</span><span class="p">,</span> <span class="nx">Role</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">./middleware/rbac</span><span class="dl">'</span><span class="p">;</span>

<span class="c1">// Admin: Get all users</span>
<span class="nx">app</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="dl">'</span><span class="s1">/auth/admin/users</span><span class="dl">'</span><span class="p">,</span> 
  <span class="nx">authenticateToken</span><span class="p">,</span> 
  <span class="nx">requirePermission</span><span class="p">(</span><span class="nx">Permission</span><span class="p">.</span><span class="nx">READ_ALL_USERS</span><span class="p">),</span>
  <span class="k">async</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">):</span> <span class="nb">Promise</span><span class="o">&lt;</span><span class="k">void</span><span class="o">&gt;</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="k">try</span> <span class="p">{</span>
      <span class="kd">const</span> <span class="nx">result</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">pool</span><span class="p">.</span><span class="nx">query</span><span class="p">(</span><span class="s2">`
        SELECT id, email, first_name, last_name, role, email_verified, 
               created_at, last_login, is_active
        FROM users
        ORDER BY created_at DESC
        LIMIT 100
      `</span><span class="p">);</span>
      
      <span class="nx">res</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span> <span class="na">users</span><span class="p">:</span> <span class="nx">result</span><span class="p">.</span><span class="nx">rows</span> <span class="p">});</span>
    <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">500</span><span class="p">).</span><span class="nx">json</span><span class="p">({</span> <span class="na">error</span><span class="p">:</span> <span class="dl">'</span><span class="s1">Failed to fetch users</span><span class="dl">'</span> <span class="p">});</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">);</span>

<span class="c1">// Admin: Update user role</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">patch</span><span class="p">(</span><span class="dl">'</span><span class="s1">/auth/admin/users/:userId/role</span><span class="dl">'</span><span class="p">,</span>
  <span class="nx">authenticateToken</span><span class="p">,</span>
  <span class="nx">requirePermission</span><span class="p">(</span><span class="nx">Permission</span><span class="p">.</span><span class="nx">MANAGE_ROLES</span><span class="p">),</span>
  <span class="k">async</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">):</span> <span class="nb">Promise</span><span class="o">&lt;</span><span class="k">void</span><span class="o">&gt;</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="p">{</span> <span class="nx">userId</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">;</span>
    <span class="kd">const</span> <span class="p">{</span> <span class="nx">role</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">;</span>
    
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">Object</span><span class="p">.</span><span class="nx">values</span><span class="p">(</span><span class="nx">Role</span><span class="p">).</span><span class="nx">includes</span><span class="p">(</span><span class="nx">role</span><span class="p">))</span> <span class="p">{</span>
      <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">400</span><span class="p">).</span><span class="nx">json</span><span class="p">({</span> <span class="na">error</span><span class="p">:</span> <span class="dl">'</span><span class="s1">Invalid role</span><span class="dl">'</span> <span class="p">});</span>
      <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>
    
    <span class="k">try</span> <span class="p">{</span>
      <span class="k">await</span> <span class="nx">pool</span><span class="p">.</span><span class="nx">query</span><span class="p">(</span><span class="dl">'</span><span class="s1">UPDATE users SET role = $1 WHERE id = $2</span><span class="dl">'</span><span class="p">,</span> <span class="p">[</span><span class="nx">role</span><span class="p">,</span> <span class="nx">userId</span><span class="p">]);</span>
      <span class="k">await</span> <span class="nx">logAuthEvent</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">user</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span> <span class="dl">'</span><span class="s1">ROLE_UPDATED</span><span class="dl">'</span><span class="p">,</span> <span class="kc">true</span><span class="p">,</span> <span class="nx">req</span><span class="p">,</span> <span class="p">{</span> 
        <span class="na">targetUserId</span><span class="p">:</span> <span class="nx">userId</span><span class="p">,</span> 
        <span class="na">newRole</span><span class="p">:</span> <span class="nx">role</span> 
      <span class="p">});</span>
      
      <span class="nx">res</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span> <span class="na">message</span><span class="p">:</span> <span class="dl">'</span><span class="s1">Role updated successfully</span><span class="dl">'</span> <span class="p">});</span>
    <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">500</span><span class="p">).</span><span class="nx">json</span><span class="p">({</span> <span class="na">error</span><span class="p">:</span> <span class="dl">'</span><span class="s1">Failed to update role</span><span class="dl">'</span> <span class="p">});</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">);</span>

<span class="c1">// Admin: View audit logs</span>
<span class="nx">app</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="dl">'</span><span class="s1">/auth/admin/audit-logs</span><span class="dl">'</span><span class="p">,</span>
  <span class="nx">authenticateToken</span><span class="p">,</span>
  <span class="nx">requireRole</span><span class="p">(</span><span class="nx">Role</span><span class="p">.</span><span class="nx">ADMIN</span><span class="p">),</span>
  <span class="k">async</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">):</span> <span class="nb">Promise</span><span class="o">&lt;</span><span class="k">void</span><span class="o">&gt;</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="k">try</span> <span class="p">{</span>
      <span class="kd">const</span> <span class="nx">result</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">pool</span><span class="p">.</span><span class="nx">query</span><span class="p">(</span><span class="s2">`
        SELECT * FROM auth_audit_log
        ORDER BY created_at DESC
        LIMIT 500
      `</span><span class="p">);</span>
      
      <span class="nx">res</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span> <span class="na">logs</span><span class="p">:</span> <span class="nx">result</span><span class="p">.</span><span class="nx">rows</span> <span class="p">});</span>
    <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">500</span><span class="p">).</span><span class="nx">json</span><span class="p">({</span> <span class="na">error</span><span class="p">:</span> <span class="dl">'</span><span class="s1">Failed to fetch audit logs</span><span class="dl">'</span> <span class="p">});</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">);</span>
</code></pre></div></div>

<hr />

<h2 id="-nice-to-have---day-5--beyond">ğŸŸ¢ NICE TO HAVE - Day 5 &amp; Beyond</h2>

<h3 id="9-basic-monitoring-dashboard-">9. Basic Monitoring Dashboard ğŸ“Š</h3>

<p><strong>Quick Implementation</strong> (30 minutes):</p>
<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Add to services/auth-service/src/index.ts</span>
<span class="kd">const</span> <span class="nx">metrics</span> <span class="o">=</span> <span class="p">{</span>
  <span class="na">loginAttempts</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
  <span class="na">loginSuccess</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
  <span class="na">loginFailures</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
  <span class="na">registrations</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
  <span class="na">passwordResets</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
  <span class="na">activeSessions</span><span class="p">:</span> <span class="k">new</span> <span class="nb">Set</span><span class="p">(),</span>
  <span class="na">startTime</span><span class="p">:</span> <span class="nb">Date</span><span class="p">.</span><span class="nx">now</span><span class="p">()</span>
<span class="p">};</span>

<span class="nx">app</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="dl">'</span><span class="s1">/auth/metrics</span><span class="dl">'</span><span class="p">,</span> <span class="nx">authenticateToken</span><span class="p">,</span> <span class="nx">requireRole</span><span class="p">(</span><span class="nx">Role</span><span class="p">.</span><span class="nx">ADMIN</span><span class="p">),</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">uptime</span> <span class="o">=</span> <span class="nb">Date</span><span class="p">.</span><span class="nx">now</span><span class="p">()</span> <span class="o">-</span> <span class="nx">metrics</span><span class="p">.</span><span class="nx">startTime</span><span class="p">;</span>
  <span class="kd">const</span> <span class="nx">successRate</span> <span class="o">=</span> <span class="nx">metrics</span><span class="p">.</span><span class="nx">loginAttempts</span> <span class="o">&gt;</span> <span class="mi">0</span> 
    <span class="p">?</span> <span class="p">(</span><span class="nx">metrics</span><span class="p">.</span><span class="nx">loginSuccess</span> <span class="o">/</span> <span class="nx">metrics</span><span class="p">.</span><span class="nx">loginAttempts</span> <span class="o">*</span> <span class="mi">100</span><span class="p">).</span><span class="nx">toFixed</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    <span class="p">:</span> <span class="mi">0</span><span class="p">;</span>
    
  <span class="nx">res</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span>
    <span class="na">uptime</span><span class="p">:</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">(</span><span class="nx">uptime</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">),</span>
    <span class="na">metrics</span><span class="p">:</span> <span class="p">{</span>
      <span class="p">...</span><span class="nx">metrics</span><span class="p">,</span>
      <span class="na">activeSessions</span><span class="p">:</span> <span class="nx">metrics</span><span class="p">.</span><span class="nx">activeSessions</span><span class="p">.</span><span class="nx">size</span><span class="p">,</span>
      <span class="na">successRate</span><span class="p">:</span> <span class="s2">`</span><span class="p">${</span><span class="nx">successRate</span><span class="p">}</span><span class="s2">%`</span>
    <span class="p">}</span>
  <span class="p">});</span>
<span class="p">});</span>
</code></pre></div></div>

<h3 id="10-session-management-endpoints-">10. Session Management Endpoints ğŸ”„</h3>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Get active sessions</span>
<span class="nx">app</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="dl">'</span><span class="s1">/auth/sessions</span><span class="dl">'</span><span class="p">,</span> <span class="nx">authenticateToken</span><span class="p">,</span> <span class="k">async</span> <span class="p">(</span><span class="nx">req</span><span class="p">:</span> <span class="kr">any</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">result</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">pool</span><span class="p">.</span><span class="nx">query</span><span class="p">(</span><span class="s2">`
    SELECT id, created_at, expires_at, ip_address, user_agent
    FROM user_sessions
    WHERE user_id = $1 AND expires_at &gt; NOW()
    ORDER BY created_at DESC
  `</span><span class="p">,</span> <span class="p">[</span><span class="nx">req</span><span class="p">.</span><span class="nx">user</span><span class="p">.</span><span class="nx">id</span><span class="p">]);</span>
  
  <span class="nx">res</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span> <span class="na">sessions</span><span class="p">:</span> <span class="nx">result</span><span class="p">.</span><span class="nx">rows</span> <span class="p">});</span>
<span class="p">});</span>

<span class="c1">// Revoke specific session</span>
<span class="nx">app</span><span class="p">.</span><span class="k">delete</span><span class="p">(</span><span class="dl">'</span><span class="s1">/auth/sessions/:sessionId</span><span class="dl">'</span><span class="p">,</span> <span class="nx">authenticateToken</span><span class="p">,</span> <span class="k">async</span> <span class="p">(</span><span class="nx">req</span><span class="p">:</span> <span class="kr">any</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="k">await</span> <span class="nx">pool</span><span class="p">.</span><span class="nx">query</span><span class="p">(</span>
    <span class="dl">'</span><span class="s1">DELETE FROM user_sessions WHERE id = $1 AND user_id = $2</span><span class="dl">'</span><span class="p">,</span>
    <span class="p">[</span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">sessionId</span><span class="p">,</span> <span class="nx">req</span><span class="p">.</span><span class="nx">user</span><span class="p">.</span><span class="nx">id</span><span class="p">]</span>
  <span class="p">);</span>
  
  <span class="nx">res</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span> <span class="na">message</span><span class="p">:</span> <span class="dl">'</span><span class="s1">Session revoked</span><span class="dl">'</span> <span class="p">});</span>
<span class="p">});</span>

<span class="c1">// Revoke all sessions (logout everywhere)</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="dl">'</span><span class="s1">/auth/logout-all</span><span class="dl">'</span><span class="p">,</span> <span class="nx">authenticateToken</span><span class="p">,</span> <span class="k">async</span> <span class="p">(</span><span class="nx">req</span><span class="p">:</span> <span class="kr">any</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="k">await</span> <span class="nx">pool</span><span class="p">.</span><span class="nx">query</span><span class="p">(</span><span class="dl">'</span><span class="s1">DELETE FROM user_sessions WHERE user_id = $1</span><span class="dl">'</span><span class="p">,</span> <span class="p">[</span><span class="nx">req</span><span class="p">.</span><span class="nx">user</span><span class="p">.</span><span class="nx">id</span><span class="p">]);</span>
  <span class="nx">res</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span> <span class="na">message</span><span class="p">:</span> <span class="dl">'</span><span class="s1">All sessions revoked</span><span class="dl">'</span> <span class="p">});</span>
<span class="p">});</span>
</code></pre></div></div>

<hr />

<h2 id="-testing-commands">ğŸ“‹ Testing Commands</h2>

<h3 id="quick-test-suite">Quick Test Suite</h3>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 1. Test registration</span>
curl <span class="nt">-X</span> POST http://localhost:3002/auth/register <span class="se">\</span>
  <span class="nt">-H</span> <span class="s2">"Content-Type: application/json"</span> <span class="se">\</span>
  <span class="nt">-d</span> <span class="s1">'{
    "email": "test@example.com",
    "password": "SecureP@ssw0rd123!",
    "firstName": "Test",
    "lastName": "User"
  }'</span>

<span class="c"># 2. Test login</span>
curl <span class="nt">-X</span> POST http://localhost:3002/auth/login <span class="se">\</span>
  <span class="nt">-H</span> <span class="s2">"Content-Type: application/json"</span> <span class="se">\</span>
  <span class="nt">-d</span> <span class="s1">'{
    "email": "test@example.com",
    "password": "SecureP@ssw0rd123!"
  }'</span>

<span class="c"># 3. Test with token (replace YOUR_TOKEN)</span>
curl <span class="nt">-X</span> GET http://localhost:3002/auth/profile <span class="se">\</span>
  <span class="nt">-H</span> <span class="s2">"Authorization: Bearer YOUR_TOKEN"</span>

<span class="c"># 4. Test password reset request</span>
curl <span class="nt">-X</span> POST http://localhost:3002/auth/forgot-password <span class="se">\</span>
  <span class="nt">-H</span> <span class="s2">"Content-Type: application/json"</span> <span class="se">\</span>
  <span class="nt">-d</span> <span class="s1">'{"email": "test@example.com"}'</span>

<span class="c"># 5. Test metrics (admin only)</span>
curl <span class="nt">-X</span> GET http://localhost:3002/auth/metrics <span class="se">\</span>
  <span class="nt">-H</span> <span class="s2">"Authorization: Bearer ADMIN_TOKEN"</span>
</code></pre></div></div>

<h3 id="integration-test">Integration Test</h3>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Create test file: services/auth-service/test-beta.js</span>
<span class="nb">cat</span> <span class="o">&gt;</span> services/auth-service/test-beta.js <span class="o">&lt;&lt;</span> <span class="sh">'</span><span class="no">EOF</span><span class="sh">'
const axios = require('axios');

const API_URL = 'http://localhost:3002';
let accessToken = '';
let refreshToken = '';

async function testAuthFlow() {
  console.log('ğŸ§ª Testing Auth Service Beta Readiness...</span><span class="se">\n</span><span class="sh">');
  
  try {
    // 1. Test Registration
    console.log('1ï¸âƒ£ Testing Registration...');
    const registerRes = await axios.post(`</span><span class="k">${</span><span class="nv">API_URL</span><span class="k">}</span><span class="sh">/auth/register`, {
      email: `test-</span><span class="k">${</span><span class="nv">Date</span><span class="p">.now()</span><span class="k">}</span><span class="sh">@example.com`,
      password: 'TestP@ssw0rd123!',
      firstName: 'Beta',
      lastName: 'Tester'
    });
    console.log('âœ… Registration successful:', registerRes.data.success);
    
    // 2. Test Weak Password
    console.log('</span><span class="se">\n</span><span class="sh">2ï¸âƒ£ Testing Password Validation...');
    try {
      await axios.post(`</span><span class="k">${</span><span class="nv">API_URL</span><span class="k">}</span><span class="sh">/auth/register`, {
        email: 'weak@example.com',
        password: 'weak'
      });
      console.log('âŒ Weak password accepted (FAIL)');
    } catch (err) {
      console.log('âœ… Weak password rejected');
    }
    
    // 3. Test Login
    console.log('</span><span class="se">\n</span><span class="sh">3ï¸âƒ£ Testing Login...');
    const loginRes = await axios.post(`</span><span class="k">${</span><span class="nv">API_URL</span><span class="k">}</span><span class="sh">/auth/login`, {
      email: registerRes.data.email,
      password: 'TestP@ssw0rd123!'
    });
    accessToken = loginRes.data.tokens.accessToken;
    refreshToken = loginRes.data.tokens.refreshToken;
    console.log('âœ… Login successful, tokens received');
    
    // 4. Test Protected Route
    console.log('</span><span class="se">\n</span><span class="sh">4ï¸âƒ£ Testing Protected Route...');
    const profileRes = await axios.get(`</span><span class="k">${</span><span class="nv">API_URL</span><span class="k">}</span><span class="sh">/auth/profile`, {
      headers: { Authorization: `Bearer </span><span class="k">${</span><span class="nv">accessToken</span><span class="k">}</span><span class="sh">` }
    });
    console.log('âœ… Protected route accessible:', profileRes.data.user.email);
    
    // 5. Test Invalid Token
    console.log('</span><span class="se">\n</span><span class="sh">5ï¸âƒ£ Testing Invalid Token...');
    try {
      await axios.get(`</span><span class="k">${</span><span class="nv">API_URL</span><span class="k">}</span><span class="sh">/auth/profile`, {
        headers: { Authorization: 'Bearer invalid-token' }
      });
      console.log('âŒ Invalid token accepted (FAIL)');
    } catch (err) {
      console.log('âœ… Invalid token rejected');
    }
    
    // 6. Test Refresh Token
    console.log('</span><span class="se">\n</span><span class="sh">6ï¸âƒ£ Testing Token Refresh...');
    const refreshRes = await axios.post(`</span><span class="k">${</span><span class="nv">API_URL</span><span class="k">}</span><span class="sh">/auth/refresh`, {
      refreshToken: refreshToken
    });
    console.log('âœ… Token refresh successful');
    
    console.log('</span><span class="se">\n</span><span class="sh">ğŸ‰ All tests passed! Auth service is beta ready.');
    
  } catch (error) {
    console.error('</span><span class="se">\n</span><span class="sh">âŒ Test failed:', error.response?.data || error.message);
    process.exit(1);
  }
}

testAuthFlow();
</span><span class="no">EOF

</span><span class="c"># Run the test</span>
node services/auth-service/test-beta.js
</code></pre></div></div>

<hr />

<h2 id="-deployment-checklist">ğŸš€ Deployment Checklist</h2>

<h3 id="environment-variables-envproduction">Environment Variables (.env.production)</h3>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Required for Beta Launch</span>
<span class="nv">NODE_ENV</span><span class="o">=</span>production
<span class="nv">PORT</span><span class="o">=</span>3002

<span class="c"># Database</span>
<span class="nv">DATABASE_URL</span><span class="o">=</span>postgresql://user:pass@host:5432/devmentor_prod
<span class="nv">REDIS_URL</span><span class="o">=</span>redis://redis:6379

<span class="c"># Security (MUST CHANGE)</span>
<span class="nv">JWT_SECRET</span><span class="o">=</span>&lt;generate-with-openssl&gt;
<span class="nv">JWT_ALGORITHM</span><span class="o">=</span>RS256
<span class="nv">ACCESS_TOKEN_EXPIRES</span><span class="o">=</span>15m
<span class="nv">REFRESH_TOKEN_EXPIRES</span><span class="o">=</span>7d

<span class="c"># Email (Required for verification)</span>
<span class="nv">SENDGRID_API_KEY</span><span class="o">=</span>&lt;your-sendgrid-key&gt;
<span class="nv">FROM_EMAIL</span><span class="o">=</span>noreply@devmentor.app
<span class="nv">APP_URL</span><span class="o">=</span>https://devmentor.app

<span class="c"># OAuth (Optional but recommended)</span>
<span class="nv">GITHUB_CLIENT_ID</span><span class="o">=</span>&lt;github-oauth-app-id&gt;
<span class="nv">GITHUB_CLIENT_SECRET</span><span class="o">=</span>&lt;github-oauth-secret&gt;

<span class="c"># Monitoring (Optional)</span>
<span class="nv">SENTRY_DSN</span><span class="o">=</span>&lt;sentry-project-dsn&gt;
</code></pre></div></div>

<h3 id="docker-build--deploy">Docker Build &amp; Deploy</h3>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Build production image</span>
<span class="nb">cd </span>services/auth-service
docker build <span class="nt">-t</span> devmentor/auth-service:beta <span class="nb">.</span>

<span class="c"># Test locally</span>
docker run <span class="nt">-p</span> 3002:3002 <span class="se">\</span>
  <span class="nt">--env-file</span> .env.production <span class="se">\</span>
  devmentor/auth-service:beta

<span class="c"># Push to registry</span>
docker tag devmentor/auth-service:beta your-registry/devmentor/auth-service:beta
docker push your-registry/devmentor/auth-service:beta

<span class="c"># Deploy to Kubernetes</span>
kubectl apply <span class="nt">-f</span> deployment/k8s/auth-service.yaml
kubectl rollout status deployment/auth-service <span class="nt">-n</span> devmentor
</code></pre></div></div>

<h3 id="database-migration">Database Migration</h3>
<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">-- Run before deployment</span>
<span class="k">BEGIN</span><span class="p">;</span>

<span class="c1">-- Add missing indexes for performance</span>
<span class="k">CREATE</span> <span class="k">INDEX</span> <span class="n">IF</span> <span class="k">NOT</span> <span class="k">EXISTS</span> <span class="n">idx_users_email</span> <span class="k">ON</span> <span class="n">users</span><span class="p">(</span><span class="n">email</span><span class="p">);</span>
<span class="k">CREATE</span> <span class="k">INDEX</span> <span class="n">IF</span> <span class="k">NOT</span> <span class="k">EXISTS</span> <span class="n">idx_users_created_at</span> <span class="k">ON</span> <span class="n">users</span><span class="p">(</span><span class="n">created_at</span> <span class="k">DESC</span><span class="p">);</span>
<span class="k">CREATE</span> <span class="k">INDEX</span> <span class="n">IF</span> <span class="k">NOT</span> <span class="k">EXISTS</span> <span class="n">idx_sessions_user_id</span> <span class="k">ON</span> <span class="n">user_sessions</span><span class="p">(</span><span class="n">user_id</span><span class="p">);</span>
<span class="k">CREATE</span> <span class="k">INDEX</span> <span class="n">IF</span> <span class="k">NOT</span> <span class="k">EXISTS</span> <span class="n">idx_sessions_expires</span> <span class="k">ON</span> <span class="n">user_sessions</span><span class="p">(</span><span class="n">expires_at</span><span class="p">);</span>
<span class="k">CREATE</span> <span class="k">INDEX</span> <span class="n">IF</span> <span class="k">NOT</span> <span class="k">EXISTS</span> <span class="n">idx_audit_user_id</span> <span class="k">ON</span> <span class="n">auth_audit_log</span><span class="p">(</span><span class="n">user_id</span><span class="p">);</span>
<span class="k">CREATE</span> <span class="k">INDEX</span> <span class="n">IF</span> <span class="k">NOT</span> <span class="k">EXISTS</span> <span class="n">idx_audit_created</span> <span class="k">ON</span> <span class="n">auth_audit_log</span><span class="p">(</span><span class="n">created_at</span> <span class="k">DESC</span><span class="p">);</span>

<span class="c1">-- Add default admin user (change password immediately)</span>
<span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">users</span> <span class="p">(</span><span class="n">email</span><span class="p">,</span> <span class="n">password_hash</span><span class="p">,</span> <span class="n">first_name</span><span class="p">,</span> <span class="n">last_name</span><span class="p">,</span> <span class="k">role</span><span class="p">,</span> <span class="n">email_verified</span><span class="p">)</span>
<span class="k">VALUES</span> <span class="p">(</span>
  <span class="s1">'admin@devmentor.app'</span><span class="p">,</span>
  <span class="s1">'$2b$12$LQv3c1yqBWVHxkd0LHAkCOYz6TtxMQJqhN8/LewY/jLwvBwPj2Bie'</span><span class="p">,</span> <span class="c1">-- Change@Me123!</span>
  <span class="s1">'Admin'</span><span class="p">,</span>
  <span class="s1">'User'</span><span class="p">,</span>
  <span class="s1">'admin'</span><span class="p">,</span>
  <span class="k">true</span>
<span class="p">)</span> <span class="k">ON</span> <span class="n">CONFLICT</span> <span class="p">(</span><span class="n">email</span><span class="p">)</span> <span class="k">DO</span> <span class="k">NOTHING</span><span class="p">;</span>

<span class="k">COMMIT</span><span class="p">;</span>
</code></pre></div></div>

<hr />

<h2 id="-final-validation-checklist">âœ… Final Validation Checklist</h2>

<h3 id="security">Security</h3>
<ul class="task-list">
  <li class="task-list-item"><input type="checkbox" class="task-list-item-checkbox" disabled="disabled" />JWT secret is 64+ characters and unique</li>
  <li class="task-list-item"><input type="checkbox" class="task-list-item-checkbox" disabled="disabled" />Passwords require 12+ chars with complexity</li>
  <li class="task-list-item"><input type="checkbox" class="task-list-item-checkbox" disabled="disabled" />Account lockout after 5 failed attempts</li>
  <li class="task-list-item"><input type="checkbox" class="task-list-item-checkbox" disabled="disabled" />CSRF protection enabled</li>
  <li class="task-list-item"><input type="checkbox" class="task-list-item-checkbox" disabled="disabled" />Rate limiting configured</li>
  <li class="task-list-item"><input type="checkbox" class="task-list-item-checkbox" disabled="disabled" />SQL injection prevention verified</li>
  <li class="task-list-item"><input type="checkbox" class="task-list-item-checkbox" disabled="disabled" />XSS protection headers set</li>
</ul>

<h3 id="features">Features</h3>
<ul class="task-list">
  <li class="task-list-item"><input type="checkbox" class="task-list-item-checkbox" disabled="disabled" />User registration works</li>
  <li class="task-list-item"><input type="checkbox" class="task-list-item-checkbox" disabled="disabled" />Email verification sends</li>
  <li class="task-list-item"><input type="checkbox" class="task-list-item-checkbox" disabled="disabled" />Login with valid credentials succeeds</li>
  <li class="task-list-item"><input type="checkbox" class="task-list-item-checkbox" disabled="disabled" />Login with invalid credentials fails</li>
  <li class="task-list-item"><input type="checkbox" class="task-list-item-checkbox" disabled="disabled" />Password reset flow complete</li>
  <li class="task-list-item"><input type="checkbox" class="task-list-item-checkbox" disabled="disabled" />Token refresh works</li>
  <li class="task-list-item"><input type="checkbox" class="task-list-item-checkbox" disabled="disabled" />Protected routes require auth</li>
  <li class="task-list-item"><input type="checkbox" class="task-list-item-checkbox" disabled="disabled" />Admin routes require admin role</li>
</ul>

<h3 id="performance">Performance</h3>
<ul class="task-list">
  <li class="task-list-item"><input type="checkbox" class="task-list-item-checkbox" disabled="disabled" />Response time &lt; 200ms for auth endpoints</li>
  <li class="task-list-item"><input type="checkbox" class="task-list-item-checkbox" disabled="disabled" />Can handle 100 concurrent users</li>
  <li class="task-list-item"><input type="checkbox" class="task-list-item-checkbox" disabled="disabled" />Database queries optimized with indexes</li>
  <li class="task-list-item"><input type="checkbox" class="task-list-item-checkbox" disabled="disabled" />Redis caching configured</li>
  <li class="task-list-item"><input type="checkbox" class="task-list-item-checkbox" disabled="disabled" />Connection pooling enabled</li>
</ul>

<h3 id="monitoring">Monitoring</h3>
<ul class="task-list">
  <li class="task-list-item"><input type="checkbox" class="task-list-item-checkbox" disabled="disabled" />Health check endpoint returns 200</li>
  <li class="task-list-item"><input type="checkbox" class="task-list-item-checkbox" disabled="disabled" />Metrics endpoint shows data</li>
  <li class="task-list-item"><input type="checkbox" class="task-list-item-checkbox" disabled="disabled" />Audit logs being written</li>
  <li class="task-list-item"><input type="checkbox" class="task-list-item-checkbox" disabled="disabled" />Error logging configured</li>
  <li class="task-list-item"><input type="checkbox" class="task-list-item-checkbox" disabled="disabled" />Alerts set up for failures</li>
</ul>

<hr />

<h2 id="-success-criteria">ğŸ¯ Success Criteria</h2>

<p>The auth service is <strong>beta ready</strong> when:</p>

<ol>
  <li>âœ… All 8 MUST HAVE items are completed</li>
  <li>âœ… Security test suite passes</li>
  <li>âœ… Load test handles 100 concurrent users</li>
  <li>âœ… No critical vulnerabilities in <code class="language-plaintext highlighter-rouge">npm audit</code></li>
  <li>âœ… Documentation is updated</li>
  <li>âœ… Admin can manage users</li>
  <li>âœ… Monitoring shows healthy metrics</li>
  <li>âœ… Deployed to staging environment</li>
</ol>

<hr />

<h2 id="-support--troubleshooting">ğŸ“ Support &amp; Troubleshooting</h2>

<h3 id="common-issues">Common Issues</h3>

<p><strong>Issue</strong>: JWT Secret not loading</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Fix: Ensure .env file is loaded</span>
<span class="nb">export </span><span class="nv">JWT_SECRET</span><span class="o">=</span><span class="si">$(</span>openssl rand <span class="nt">-base64</span> 64<span class="si">)</span>
<span class="c"># Or add to .env file</span>
</code></pre></div></div>

<p><strong>Issue</strong>: Email not sending</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Fix: Check SendGrid API key</span>
curl <span class="nt">-X</span> POST https://api.sendgrid.com/v3/mail/send <span class="se">\</span>
  <span class="nt">-H</span> <span class="s2">"Authorization: Bearer </span><span class="nv">$SENDGRID_API_KEY</span><span class="s2">"</span> <span class="se">\</span>
  <span class="nt">-H</span> <span class="s2">"Content-Type: application/json"</span> <span class="se">\</span>
  <span class="nt">-d</span> <span class="s1">'{"personalizations":[{"to":[{"email":"test@example.com"}]}],"from":{"email":"test@example.com"},"subject":"Test","content":[{"type":"text/plain","value":"Test"}]}'</span>
</code></pre></div></div>

<p><strong>Issue</strong>: Database connection failed</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Fix: Test connection</span>
psql <span class="nv">$DATABASE_URL</span> <span class="nt">-c</span> <span class="s2">"SELECT 1"</span>
<span class="c"># Check Docker network</span>
docker network <span class="nb">ls
</span>docker network inspect devmentor_default
</code></pre></div></div>

<p><strong>Issue</strong>: Redis connection failed</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Fix: Test Redis</span>
redis-cli <span class="nt">-h</span> localhost <span class="nt">-p</span> 6379 ping
<span class="c"># Should return PONG</span>
</code></pre></div></div>

<hr />

<h2 id="-timeline">ğŸ“… Timeline</h2>

<table>
  <thead>
    <tr>
      <th>Day</th>
      <th>Tasks</th>
      <th>Status</th>
      <th>Blocking Beta?</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><strong>Day 1</strong></td>
      <td>Tasks 1-3: JWT, Lockout, Passwords</td>
      <td>âŒ</td>
      <td>YES</td>
    </tr>
    <tr>
      <td><strong>Day 2</strong></td>
      <td>Tasks 4-5: CSRF, Token Times</td>
      <td>âŒ</td>
      <td>YES</td>
    </tr>
    <tr>
      <td><strong>Day 3</strong></td>
      <td>Task 6: Email Verification</td>
      <td>âŒ</td>
      <td>YES</td>
    </tr>
    <tr>
      <td><strong>Day 4</strong></td>
      <td>Tasks 7-8: Password Reset, RBAC</td>
      <td>âŒ</td>
      <td>YES</td>
    </tr>
    <tr>
      <td><strong>Day 5</strong></td>
      <td>Testing, Monitoring, Deployment</td>
      <td>âŒ</td>
      <td>NO</td>
    </tr>
  </tbody>
</table>

<hr />

<p><em>Last Updated: August 16, 2025</em><br />
<em>Generated for: DevMentor Beta Launch</em><br />
<em>Critical Path: 8 items in 5 days</em></p>



<div style="margin-top: 3rem; padding: 1rem; background: #f6f8fa; border-radius: 5px;">
  <p style="margin: 0; color: #666; font-size: 0.9em;">
    ğŸ“ Source: DevMentor / infrastructure/services/auth-service/AUTH_BETA_READINESS.md
  </p>
</div>

  </main>

  <footer>
    <p>&copy; 2024 NatureQuest. Documentation Hub v1.0.0</p>
  </footer>
</body>
</html>
