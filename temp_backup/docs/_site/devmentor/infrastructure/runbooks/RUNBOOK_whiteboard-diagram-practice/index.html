<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>RUNBOOK whiteboard-diagram-practice | NatureQuest Documentation Hub</title>
  
  <!-- Google Fonts for better readability -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
  
  <style>
    :root {
      --primary-color: #0969da;
      --text-color: #24292f;
      --text-light: #57606a;
      --bg-light: #f6f8fa;
      --border-color: #d1d9e0;
    }
    
    * {
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
      font-size: 16px;
      line-height: 1.7;
      color: var(--text-color);
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      font-feature-settings: "kern" 1, "liga" 1;
    }
    
    /* Typography improvements */
    p {
      margin: 1.25rem 0;
      letter-spacing: -0.011em;
    }
    
    a {
      color: var(--primary-color);
      text-decoration: none;
      transition: all 0.2s ease;
    }
    
    a:hover {
      text-decoration: underline;
      opacity: 0.8;
    }
    
    /* Improved headings */
    h1, h2, h3, h4, h5, h6 {
      font-weight: 600;
      line-height: 1.3;
      margin-top: 2rem;
      margin-bottom: 1rem;
      letter-spacing: -0.02em;
    }
    
    h1 {
      font-size: 2.5rem;
      font-weight: 800;
      color: var(--primary-color);
      margin-top: 0;
      letter-spacing: -0.03em;
    }
    
    h2 {
      font-size: 1.875rem;
      font-weight: 700;
      color: var(--text-color);
      border-bottom: 1px solid var(--border-color);
      padding-bottom: 0.5rem;
    }
    
    h3 {
      font-size: 1.5rem;
      font-weight: 600;
      color: var(--text-color);
    }
    
    h4 {
      font-size: 1.25rem;
      font-weight: 600;
      color: var(--text-color);
    }
    
    /* Lists with better spacing */
    ul, ol {
      padding-left: 1.5rem;
      margin: 1.25rem 0;
    }
    
    li {
      margin: 0.5rem 0;
      line-height: 1.7;
    }
    
    /* Strong text */
    strong, b {
      font-weight: 600;
      color: var(--text-color);
    }
    
    /* Navigation */
    nav {
      background: linear-gradient(135deg, #f6f8fa 0%, #ffffff 100%);
      padding: 1.25rem;
      margin-bottom: 2rem;
      border-radius: 8px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.05);
    }
    
    nav ul {
      list-style: none;
      padding: 0;
      display: flex;
      gap: 1.5rem;
      flex-wrap: wrap;
      margin: 0;
    }
    
    nav li {
      margin: 0;
    }
    
    nav a {
      color: var(--text-color);
      text-decoration: none;
      font-weight: 500;
      font-size: 0.95rem;
      padding: 0.25rem 0.5rem;
      border-radius: 4px;
      transition: all 0.2s ease;
    }
    
    nav a:hover {
      background: var(--bg-light);
      color: var(--primary-color);
      text-decoration: none;
      opacity: 1;
    }
    
    /* Code blocks with JetBrains Mono */
    pre {
      background: var(--bg-light);
      padding: 1.25rem;
      border-radius: 8px;
      overflow-x: auto;
      border: 1px solid var(--border-color);
      margin: 1.5rem 0;
      font-size: 0.9rem;
    }
    
    code {
      font-family: 'JetBrains Mono', 'Consolas', 'Monaco', monospace;
      background: var(--bg-light);
      padding: 0.15rem 0.35rem;
      border-radius: 4px;
      font-size: 0.875em;
      font-weight: 500;
    }
    
    pre code {
      background: none;
      padding: 0;
      font-size: 0.875rem;
    }
    
    /* Tables */
    table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
      margin: 1.5rem 0;
      font-size: 0.95rem;
      border: 1px solid var(--border-color);
      border-radius: 8px;
      overflow: hidden;
    }
    
    th, td {
      padding: 0.75rem 1rem;
      text-align: left;
      border-bottom: 1px solid var(--border-color);
    }
    
    th {
      background: var(--bg-light);
      font-weight: 600;
      font-size: 0.875rem;
      text-transform: uppercase;
      letter-spacing: 0.025em;
      color: var(--text-light);
    }
    
    tr:last-child td {
      border-bottom: none;
    }
    
    tr:hover {
      background: rgba(246, 248, 250, 0.5);
    }
    
    /* Blockquotes */
    blockquote {
      margin: 1.5rem 0;
      padding: 1rem 1.25rem;
      border-left: 4px solid var(--primary-color);
      background: var(--bg-light);
      border-radius: 0 8px 8px 0;
      font-style: italic;
      color: var(--text-light);
    }
    
    /* Horizontal rules */
    hr {
      border: none;
      height: 1px;
      background: var(--border-color);
      margin: 2rem 0;
    }
    
    /* Main content area */
    main {
      min-height: 60vh;
    }
    
    /* Footer */
    footer {
      margin-top: 4rem;
      padding-top: 2rem;
      border-top: 1px solid var(--border-color);
      color: var(--text-light);
      font-size: 0.875rem;
    }
  </style>
</head>
<body>
  <nav>
    <ul>
      <li><a href="/">Home</a></li>
      <li><a href="/learning-roadmap/">Learning Roadmap</a></li>
      <li><a href="/all-docs/">All Docs</a></li>
      
      <li><a href="/">Home</a></li>
      
      <li><a href="/learning-roadmap/">Learning Roadmap</a></li>
      
      <li><a href="/devmentor/">DevMentor</a></li>
      
      <li><a href="/quizmentor/">QuizMentor</a></li>
      
      <li><a href="/harvest/">Harvest.ai</a></li>
      
      <li><a href="/naturequest-auth/">Auth</a></li>
      
      <li><a href="/infrastructure/">Infrastructure</a></li>
      
    </ul>
  </nav>

  <main>
    <div class="product-header" style="background: #f6f8fa; padding: 1rem; border-radius: 5px; margin-bottom: 2rem;">
  <span style="color: #666;">DevMentor</span> / 
  <span style="color: #999;">infrastructure/runbooks/RUNBOOK_whiteboard-diagram-practice.md</span>
</div>

<h1>RUNBOOK whiteboard-diagram-practice</h1>


<h1 id="whiteboard-diagram-practice-ingress-egress-secrets-flags-canary">Whiteboard Diagram Practice: Ingress, Egress, Secrets, Flags, Canary</h1>

<p>Audience: Engineers learning/aligning on DevMentor runtime control and traffic patterns
Goal: Practice drawing the platform from memory and verify understanding using a consistent, repeatable checklist.</p>

<p>What you will draw (boxes + arrows)</p>
<ul>
  <li>Clients &amp; DNS
    <ul>
      <li>Browser/User</li>
      <li>devmentor.local note: /etc/hosts ‚Üí 127.0.0.1 (Kind) and port-forward istio-ingressgateway 80‚Üílocalhost:8080</li>
    </ul>
  </li>
  <li>Ingress &amp; Mesh (Istio)
    <ul>
      <li>Istio IngressGateway</li>
      <li>Gateway (host: devmentor.local)</li>
      <li>VirtualService (/api/auth ‚Üí auth-service, /api/ai ‚Üí ai-gateway, /api/memory, /api/projects)</li>
      <li>
        <table>
          <tbody>
            <tr>
              <td>DestinationRules (ai-gateway, auth-service) subsets v1/v2 (Deployment labels: version: v1</td>
              <td>v2)</td>
            </tr>
          </tbody>
        </table>
      </li>
      <li>PeerAuthentication: PERMISSIVE in dev (STRICT later)</li>
    </ul>
  </li>
  <li>Core Services
    <ul>
      <li>API Gateway (8080), Auth (3002), AI Gateway (3001), Memory (3003), Project (3004)</li>
    </ul>
  </li>
  <li>Data Stores
    <ul>
      <li>Postgres, Redis, Qdrant</li>
    </ul>
  </li>
  <li>Secrets &amp; Feature Flags
    <ul>
      <li>Vault ‚Üí External Secrets Operator ‚Üí K8s Secret ‚Üí env vars in pods</li>
      <li>Unleash ‚Üí OpenFeature SDK (api-gateway, ai-gateway)</li>
    </ul>
  </li>
  <li>Observability
    <ul>
      <li>Prometheus, Grafana, Kiali, Jaeger, Loki</li>
    </ul>
  </li>
</ul>

<p>Five flows to annotate (1‚Äì5)
1) Ingress flow
   Browser ‚Üí IngressGateway ‚Üí Gateway(devmentor.local) ‚Üí VirtualService ‚Üí Service (e.g., API Gateway) ‚Üí Response
2) Egress flow (external AI API)
   AI Gateway ‚Üí ServiceEntry (e.g., api.openai.com, api.anthropic.com) ‚Üí External provider ‚Üí Response
3) Secrets flow
   Vault ‚Üí ESO ‚Üí Kubernetes Secret ‚Üí Pod env (e.g., REDIS_URL, JWT_SECRET)
4) Feature flags flow
   Unleash ‚Üí OpenFeature SDK in service ‚Üí Evaluate per request (userId) ‚Üí Toggle behavior
5) Canary flow
   VirtualService weights (e.g., 90/10) ‚Üí DestinationRule subsets v1/v2 ‚Üí Two ReplicaSets labeled version: v1/v2</p>

<p>Gotchas to write on the side</p>
<ul>
  <li>Service selector must NOT include version; subsets match pod labels (version: v1/v2)</li>
  <li>Add ServiceEntry for outbound domains or mesh won‚Äôt observe/allow egress</li>
  <li>Namespace needs istio-injection=enabled; restart pods for sidecars</li>
  <li>Start mTLS PERMISSIVE; flip to STRICT after stabilization</li>
  <li>Flags must default to safe values if provider is unavailable</li>
</ul>

<p>Step-by-step practice (15‚Äì25 minutes)
Stage 1 ‚Äî Boxes and lanes (5m)</p>
<ul>
  <li>Draw the layers: Clients &amp; DNS ‚Üí Ingress ‚Üí Mesh ‚Üí Services ‚Üí Data Stores ‚Üí Secrets/Flags ‚Üí Observability</li>
  <li>Place each component as a box. Keep space for arrows.</li>
</ul>

<p>Stage 2 ‚Äî Flows (10m)</p>
<ul>
  <li>Add arrows for the five flows above. Number each arrow leg 1.x, 2.x, etc.</li>
  <li>On each arrow, add a 1‚Äì3 word verb: ‚Äúroute‚Äù, ‚Äúeval flag‚Äù, ‚Äúread secret‚Äù, ‚Äúegress allow‚Äù.</li>
</ul>

<p>Stage 3 ‚Äî Canary math (3m)</p>
<ul>
  <li>Under ai-gateway, draw two Deployment boxes: v1 (3 pods), v2 (1 pod) labeled version: v1/v2.</li>
  <li>In the VirtualService box, write ‚Äú90/10‚Äù; in Kiali, expect 90%/10% split.</li>
</ul>

<p>Stage 4 ‚Äî Egress policy (3m)</p>
<ul>
  <li>Draw a ServiceEntry box listing api.openai.com and api.anthropic.com.</li>
  <li>Note: Prefer OutboundTrafficPolicy REGISTRY_ONLY in prod with explicit ServiceEntries.</li>
</ul>

<p>Stage 5 ‚Äî Secrets &amp; flags (3m)</p>
<ul>
  <li>Draw Vault ‚Üí ESO ‚Üí K8s Secret ‚Üí Pod env chain.</li>
  <li>Draw Unleash ‚Üí OpenFeature ‚Üí api-gateway/ai-gateway.</li>
</ul>

<p>Self-check questions (write answers on the board)</p>
<ul>
  <li>Which resource maps external host/path to a service? (VirtualService)</li>
  <li>Where do you specify canary subsets? (DestinationRule) How do pods match? (labels)</li>
  <li>How do you allow egress to OpenAI? (ServiceEntry)</li>
  <li>How do services get secrets without committing them? (Vault + ESO ‚Üí K8s Secret ‚Üí env)</li>
  <li>How can you toggle features per user, without restarts? (Unleash + OpenFeature)</li>
</ul>

<p>Verification commands (after drawing; optional quick lab)</p>
<ul>
  <li>Ingress:
    <ul>
      <li>kubectl -n istio-system port-forward svc/istio-ingressgateway 8080:80 &amp;</li>
      <li>
        <table>
          <tbody>
            <tr>
              <td>curl -s http://localhost:8080/health</td>
              <td>jq</td>
              <td>¬†</td>
              <td>true</td>
            </tr>
          </tbody>
        </table>
      </li>
    </ul>
  </li>
  <li>Mesh/Canary:
    <ul>
      <li>kubectl -n devmentor-app get virtualservice,destinationrule</li>
      <li>Check Kiali graph (pf Kiali: 20001:20001) for v1/v2 split</li>
    </ul>
  </li>
  <li>Egress:
    <ul>
      <li>kubectl -n devmentor-app get serviceentry</li>
    </ul>
  </li>
  <li>Secrets:
    <ul>
      <li>
        <table>
          <tbody>
            <tr>
              <td>kubectl -n devmentor-app get externalsecret,secret</td>
              <td>grep -E ‚Äúapi-gateway</td>
              <td>ai-gateway</td>
              <td>auth‚Äù</td>
            </tr>
          </tbody>
        </table>
      </li>
    </ul>
  </li>
  <li>Flags (sanity):
    <ul>
      <li>PF Unleash (if deployed): kubectl -n devmentor-app port-forward svc/unleash 4242:4242 &amp;</li>
    </ul>
  </li>
</ul>

<p>Acceptance checklist (tick these off)</p>
<ul>
  <li>Layers complete: Clients/DNS, Ingress, Mesh, Services, Data Stores, Secrets/Flags, Observability</li>
  <li>All five flows drawn and numbered</li>
  <li>Canary subsets v1/v2 and 90/10 split annotated</li>
  <li>Egress ServiceEntry listed with real hosts</li>
  <li>Secrets chain and flag chain drawn end-to-end</li>
</ul>

<p>Mermaid templates (optional, if you prefer text diagrams)</p>
<ul>
  <li>Architecture skeleton:
    <pre><code class="language-mermaid">flowchart LR
subgraph Clients
  B[Browser/User]
end
subgraph Ingress
  IGW[Istio IngressGateway]
  GW[Gateway devmentor.local]
  VS[VirtualService devmentor-routes]
end
subgraph Mesh
  DR1[DestinationRule ai-gateway v1/v2]
  DR2[DestinationRule auth-service v1/v2]
  PA[PeerAuthentication]
end
subgraph Services
  APIG[API Gateway]
  AUTH[Auth Service]
  AI[AI Gateway]
  MEM[Memory Service]
  PROJ[Project Service]
end
subgraph Data
  PG[(Postgres)]
  R[(Redis)]
  Q[(Qdrant)]
end
subgraph SecretsFlags
  VAULT[Vault]
  ESO[External Secrets Operator]
  K8SSEC[K8s Secret]
  UNL[Unleash]
  OF[OpenFeature SDK]
end
subgraph Obs
  PROM[Prometheus]
  GRAF[Grafana]
  KIALI[Kiali]
  JAEGER[Jaeger]
  LOKI[Loki]
end

B --&gt; IGW --&gt; GW --&gt; VS --&gt; APIG
APIG --&gt; AUTH &amp; AI &amp; MEM &amp; PROJ
AUTH --&gt; PG &amp; R
AI --&gt; R &amp; Q
MEM --&gt; PG &amp; Q &amp; R

VAULT --&gt; ESO --&gt; K8SSEC --&gt; APIG &amp; AUTH &amp; AI &amp; MEM &amp; PROJ
UNL --&gt; OF --&gt; APIG &amp; AI
</code></pre>
  </li>
  <li>Canary routing skeleton:
    <pre><code class="language-mermaid">flowchart LR
VS[VirtualService /api/ai 90/10] --&gt; DR[DestinationRule ai-gateway]
DR --&gt;|subset v1| V1[Deployment ai-gateway v1 (labels: version=v1)]
DR --&gt;|subset v2| V2[Deployment ai-gateway v2 (labels: version=v2)]
</code></pre>
  </li>
</ul>

<p>Common mistakes &amp; quick fixes</p>
<ul>
  <li>503s during canary: subsets don‚Äôt match pod labels; add version: v1/v2 labels and reapply</li>
  <li>Only one subset gets traffic: Service selector included version; remove it to select both</li>
  <li>External calls blocked: missing ServiceEntry; add domains and verify</li>
  <li>Missing sidecars in Kiali: ensure istio-injection=enabled on namespace; restart pods</li>
  <li>Flags ‚Äústuck‚Äù: provider not reachable; ensure defaults are safe and retry logic is in place</li>
</ul>

<p>When ready, snap a photo of your drawing and upload it. We‚Äôll review and correct it using this same checklist.</p>



<div style="margin-top: 3rem; padding: 1rem; background: #f6f8fa; border-radius: 5px;">
  <p style="margin: 0; color: #666; font-size: 0.9em;">
    üìÅ Source: DevMentor / infrastructure/runbooks/RUNBOOK_whiteboard-diagram-practice.md
  </p>
</div>

  </main>

  <footer>
    <p>&copy; 2024 NatureQuest. Documentation Hub v1.0.0</p>
  </footer>
</body>
</html>
